<!DOCTYPE html>
<html lang="zh-cn">

<head>
  <title>
  é€†å‘ Fastcon BLE åè®® - 2 Â· Moody&#39;s
</title>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="light dark">


<meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests; block-all-mixed-content; default-src 'self'; child-src 'self'; font-src 'self' https://fonts.gstatic.com https://cdn.jsdelivr.net; form-action 'self' https://utteranc.es; frame-src 'self' https://utteranc.es; img-src 'self' https:; object-src 'none'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.jsdelivr.net https://utteranc.es; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://utteranc.es https://static.cloudflareinsights.com https://js.monitor.azure.com; connect-src 'self' https://utteranc.es https://uksouth-1.in.applicationinsights.azure.com;">




<meta name="author" content="Moody">
<meta name="description" content="æœ¬æ–‡å†…å®¹ä¸å¾—ç”¨äºå•†ä¸šç”¨é€”
ä¸Šå›ä¹¦è¯´åˆ°â€¦â€¦ é“¾æ¥åˆ°æ ‡é¢˜ 4.6 é‡å†™ Parse BLE Broadcast å’Œ Send Start Scan èŠ±è´¹äº†æˆ‘æ•´æ•´ä¸€å‘¨çš„æ—¶é—´ã€‚
ç¬¬ä¸€æ­¥ï¼Œæˆ‘é€‰æ‹©äº† Parse BLE Broadcastï¼Œå› ä¸ºå®ƒæ˜¯ä¸€ä¸ªç®€å•çš„å‡½æ•°ï¼Œè€Œä¸”æˆ‘å·²ç»çŸ¥é“äº†å®ƒçš„è¾“å…¥å’Œè¾“å‡ºã€‚
é¦–å…ˆå°±æ˜¯å‡½æ•°ç­¾åï¼š
1 2 3 4 5 6 void parse_ble_broadcast( const u8 *data, // æ•°æ® const size_t data_len, // æ•°æ®é•¿åº¦ const u8 *phone_key, // æ‰‹æœº Keyï¼Œå¤§æ¦‚åªæœ‰ 4 bytes /* callback */ // ä¸€äº›å›è°ƒå‡½æ•°ï¼Œæˆ‘ä»¬åœ¨ C é‡Œé¢ä¸éœ€è¦ ); ç„¶åæ ¹æ® Binja å†…çš„ä¼ª C ä»£ç ï¼Œå¤§æ¦‚å†™å‡ºäº†å‡½æ•°çš„é€»è¾‘ï¼š
é¦–å…ˆè°ƒç”¨ bl_ble_fastcon_header_encrty å‡½æ•°è§£å¯†æ•°æ®å‰ 4 å­—èŠ‚çš„å¤´ï¼Œç¬¬ä¸€ä¸ª byte å³ç§» 4 ä½ä¹‹åçš„ä½ä¸‰ä½åº”è¯¥æ˜¯ header typeï¼ˆä¹Ÿå°±æ˜¯ç¬¬ 5, 6, 7 ä½ï¼‰">
<meta name="keywords" content="blog,personal,ä¸­æ–‡,ä¸ªäºº">

<meta name="twitter:card" content="summary"/><meta name="twitter:title" content="é€†å‘ Fastcon BLE åè®® - 2"/>
<meta name="twitter:description" content="æœ¬æ–‡å†…å®¹ä¸å¾—ç”¨äºå•†ä¸šç”¨é€”
ä¸Šå›ä¹¦è¯´åˆ°â€¦â€¦ é“¾æ¥åˆ°æ ‡é¢˜ 4.6 é‡å†™ Parse BLE Broadcast å’Œ Send Start Scan èŠ±è´¹äº†æˆ‘æ•´æ•´ä¸€å‘¨çš„æ—¶é—´ã€‚
ç¬¬ä¸€æ­¥ï¼Œæˆ‘é€‰æ‹©äº† Parse BLE Broadcastï¼Œå› ä¸ºå®ƒæ˜¯ä¸€ä¸ªç®€å•çš„å‡½æ•°ï¼Œè€Œä¸”æˆ‘å·²ç»çŸ¥é“äº†å®ƒçš„è¾“å…¥å’Œè¾“å‡ºã€‚
é¦–å…ˆå°±æ˜¯å‡½æ•°ç­¾åï¼š
1 2 3 4 5 6 void parse_ble_broadcast( const u8 *data, // æ•°æ® const size_t data_len, // æ•°æ®é•¿åº¦ const u8 *phone_key, // æ‰‹æœº Keyï¼Œå¤§æ¦‚åªæœ‰ 4 bytes /* callback */ // ä¸€äº›å›è°ƒå‡½æ•°ï¼Œæˆ‘ä»¬åœ¨ C é‡Œé¢ä¸éœ€è¦ ); ç„¶åæ ¹æ® Binja å†…çš„ä¼ª C ä»£ç ï¼Œå¤§æ¦‚å†™å‡ºäº†å‡½æ•°çš„é€»è¾‘ï¼š
é¦–å…ˆè°ƒç”¨ bl_ble_fastcon_header_encrty å‡½æ•°è§£å¯†æ•°æ®å‰ 4 å­—èŠ‚çš„å¤´ï¼Œç¬¬ä¸€ä¸ª byte å³ç§» 4 ä½ä¹‹åçš„ä½ä¸‰ä½åº”è¯¥æ˜¯ header typeï¼ˆä¹Ÿå°±æ˜¯ç¬¬ 5, 6, 7 ä½ï¼‰"/>

<meta property="og:title" content="é€†å‘ Fastcon BLE åè®® - 2" />
<meta property="og:description" content="æœ¬æ–‡å†…å®¹ä¸å¾—ç”¨äºå•†ä¸šç”¨é€”
ä¸Šå›ä¹¦è¯´åˆ°â€¦â€¦ é“¾æ¥åˆ°æ ‡é¢˜ 4.6 é‡å†™ Parse BLE Broadcast å’Œ Send Start Scan èŠ±è´¹äº†æˆ‘æ•´æ•´ä¸€å‘¨çš„æ—¶é—´ã€‚
ç¬¬ä¸€æ­¥ï¼Œæˆ‘é€‰æ‹©äº† Parse BLE Broadcastï¼Œå› ä¸ºå®ƒæ˜¯ä¸€ä¸ªç®€å•çš„å‡½æ•°ï¼Œè€Œä¸”æˆ‘å·²ç»çŸ¥é“äº†å®ƒçš„è¾“å…¥å’Œè¾“å‡ºã€‚
é¦–å…ˆå°±æ˜¯å‡½æ•°ç­¾åï¼š
1 2 3 4 5 6 void parse_ble_broadcast( const u8 *data, // æ•°æ® const size_t data_len, // æ•°æ®é•¿åº¦ const u8 *phone_key, // æ‰‹æœº Keyï¼Œå¤§æ¦‚åªæœ‰ 4 bytes /* callback */ // ä¸€äº›å›è°ƒå‡½æ•°ï¼Œæˆ‘ä»¬åœ¨ C é‡Œé¢ä¸éœ€è¦ ); ç„¶åæ ¹æ® Binja å†…çš„ä¼ª C ä»£ç ï¼Œå¤§æ¦‚å†™å‡ºäº†å‡½æ•°çš„é€»è¾‘ï¼š
é¦–å…ˆè°ƒç”¨ bl_ble_fastcon_header_encrty å‡½æ•°è§£å¯†æ•°æ®å‰ 4 å­—èŠ‚çš„å¤´ï¼Œç¬¬ä¸€ä¸ª byte å³ç§» 4 ä½ä¹‹åçš„ä½ä¸‰ä½åº”è¯¥æ˜¯ header typeï¼ˆä¹Ÿå°±æ˜¯ç¬¬ 5, 6, 7 ä½ï¼‰" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://mooody.me/posts/2023-04/reverse-the-fastcon-ble-protocol-2/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-04-07T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-04-07T00:00:00+00:00" />




<link rel="canonical" href="https://mooody.me/posts/2023-04/reverse-the-fastcon-ble-protocol-2/">


<link rel="preload" href="/fonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/fonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/fonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin>


  
  
  <link rel="stylesheet" href="/css/coder.min.38c4552ac40f9ae3408bad40358f654ebd8804412fe74ed56f2d6c8a7af82dd3.css" integrity="sha256-OMRVKsQPmuNAi61ANY9lTr2IBEEv507Vby1sinr4LdM=" crossorigin="anonymous" media="screen" />






  
    
    
    <link rel="stylesheet" href="/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css" integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin="anonymous" media="screen" />
  



 


  
  
    
    <link rel="stylesheet" href="/scss/cards.min.66689eb6794f4d37bf49748d47a91d8dc5918d78d800a8fae4f1a9649ce35145.css" integrity="sha256-ZmietnlPTTe/SXSNR6kdjcWRjXjYAKj65PGpZJzjUUU=" crossorigin="anonymous" media="screen" />
  

  
  
    
    <link rel="stylesheet" href="/scss/spoiler.min.6758d9b6919e25bb0a3c105fb53c53d4329838c7c3c6c41a4443a232bcca0886.css" integrity="sha256-Z1jZtpGeJbsKPBBftTxT1DKYOMfDxsQaREOiMrzKCIY=" crossorigin="anonymous" media="screen" />
  



<link rel="icon" type="image/svg+xml" href="/images/favicon.svg" sizes="any">
<link rel="icon" type="image/png" href="/images/favicon.ico" sizes="32x32">
<link rel="icon" type="image/png" href="/images/favicon.ico" sizes="16x16">

<link rel="apple-touch-icon" href="/images/favicon.ico">
<link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.ico">

<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#5bbad5">






<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css"
/>
<script
  defer
  src="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.js"
></script>
<script
  defer
  src="https://cdn.jsdelivr.net/npm/katex@latest/dist/contrib/auto-render.min.js"
  onload="renderMathInElement(document.body);"
></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    renderMathInElement(document.body, {
      delimiters: [
        { left: "$$", right: "$$", display: true },
        { left: "$", right: "$", display: false },
      ],
    });
  });
</script>



</head>






<body class="preload-transitions colorscheme-auto">
  
<div class="float-container">
    <a id="dark-mode-toggle" class="colorscheme-toggle">
        <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
    </a>
</div>


  <main class="wrapper">
    <nav class="navigation">
  <section class="container">
    
    <a class="navigation-title" href="https://mooody.me/">
      Moody&#39;s
    </a>
    
    
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa-solid fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link " href="/">ä¸»é¡µ</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="/posts/">æ–‡ç« </a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="/friends/">å‹é“¾</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="/about/">æˆ‘</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="https://g.mooody.me/public-dashboards/305e9305e46240eb80345e055738c236?orgId=1&amp;theme=light&amp;refresh=10s">æœåŠ¡çŠ¶æ€</a>
            </li>
          
        
        
          
          
          
            
          
            
              
                <li class="navigation-item menu-separator">
                  <span>|</span>
                </li>
                
              
              <li class="navigation-item">
                <a href="/en/">ğŸ‡¬ğŸ‡§</a>
              </li>
            
          
        
      </ul>
    
  </section>
</nav>


    <div class="content">
      
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">
            <a class="title-link" href="https://mooody.me/posts/2023-04/reverse-the-fastcon-ble-protocol-2/">
              é€†å‘ Fastcon BLE åè®® - 2
            </a>
          </h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fa-solid fa-calendar" aria-hidden="true"></i>
              <time datetime="2023-04-07T00:00:00Z">
                April 7, 2023
              </time>
            </span>
            <span class="reading-time">
              <i class="fa-solid fa-clock" aria-hidden="true"></i>
              é˜…è¯»æ—¶é—´ï¼š12 åˆ†é’Ÿ
            </span>
          </div>
          
          
          <div class="tags">
  <i class="fa-solid fa-tag" aria-hidden="true"></i>
    <span class="tag">
      <a href="/tags/reverse-engineering/">Reverse Engineering</a>
    </span>
      <span class="separator">â€¢</span>
    <span class="tag">
      <a href="/tags/ble/">BLE</a>
    </span>
      <span class="separator">â€¢</span>
    <span class="tag">
      <a href="/tags/fastcon/">Fastcon</a>
    </span>
      <span class="separator">â€¢</span>
    <span class="tag">
      <a href="/tags/bluetooth/">Bluetooth</a>
    </span>
      <span class="separator">â€¢</span>
    <span class="tag">
      <a href="/tags/rust/">Rust</a>
    </span>
      <span class="separator">â€¢</span>
    <span class="tag">
      <a href="/tags/arm64/">ARM64</a>
    </span></div>

        </div>
      </header>

      <div class="post-content">
        
        <p><strong>æœ¬æ–‡å†…å®¹ä¸å¾—ç”¨äºå•†ä¸šç”¨é€”</strong></p>
<h2 id="ä¸Šå›ä¹¦è¯´åˆ°">
  ä¸Šå›ä¹¦è¯´åˆ°â€¦â€¦
  <a class="heading-link" href="#%e4%b8%8a%e5%9b%9e%e4%b9%a6%e8%af%b4%e5%88%b0">
    <i class="fa-solid fa-link" aria-hidden="true" title="é“¾æ¥åˆ°æ ‡é¢˜"></i>
    <span class="sr-only">é“¾æ¥åˆ°æ ‡é¢˜</span>
  </a>
</h2>
<p><em>4.6 é‡å†™ <code>Parse BLE Broadcast</code> å’Œ <code>Send Start Scan</code> èŠ±è´¹äº†æˆ‘æ•´æ•´ä¸€å‘¨çš„æ—¶é—´ã€‚</em></p>
<p>ç¬¬ä¸€æ­¥ï¼Œæˆ‘é€‰æ‹©äº† <code>Parse BLE Broadcast</code>ï¼Œå› ä¸ºå®ƒæ˜¯ä¸€ä¸ªç®€å•çš„å‡½æ•°ï¼Œè€Œä¸”æˆ‘å·²ç»çŸ¥é“äº†å®ƒçš„è¾“å…¥å’Œè¾“å‡ºã€‚</p>
<p>é¦–å…ˆå°±æ˜¯å‡½æ•°ç­¾åï¼š</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8be9fd">void</span> <span style="color:#50fa7b">parse_ble_broadcast</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">const</span> u8 <span style="color:#ff79c6">*</span>data,         <span style="color:#6272a4">// æ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">const</span> <span style="color:#8be9fd">size_t</span> data_len,  <span style="color:#6272a4">// æ•°æ®é•¿åº¦
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">const</span> u8 <span style="color:#ff79c6">*</span>phone_key,    <span style="color:#6272a4">// æ‰‹æœº Keyï¼Œå¤§æ¦‚åªæœ‰ 4 bytes
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">/* callback */</span>          <span style="color:#6272a4">// ä¸€äº›å›è°ƒå‡½æ•°ï¼Œæˆ‘ä»¬åœ¨ C é‡Œé¢ä¸éœ€è¦
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>);
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç„¶åæ ¹æ® Binja å†…çš„ä¼ª C ä»£ç ï¼Œå¤§æ¦‚å†™å‡ºäº†å‡½æ•°çš„é€»è¾‘ï¼š</p>
<p><img alt="parse-1" src="/posts/2023-04/reverse-the-fastcon-ble-protocol-2/parse-part1.png"></p>
<p>é¦–å…ˆè°ƒç”¨ <code>bl_ble_fastcon_header_encrty</code> å‡½æ•°è§£å¯†æ•°æ®å‰ 4 å­—èŠ‚çš„å¤´ï¼Œç¬¬ä¸€ä¸ª byte å³ç§» 4
ä½ä¹‹åçš„ä½ä¸‰ä½åº”è¯¥æ˜¯ header typeï¼ˆä¹Ÿå°±æ˜¯ç¬¬ 5, 6, 7 ä½ï¼‰</p>
<p>å¦‚æœ header type æ˜¯ 1ï¼Œåˆ™è¿›å…¥æ‰€éœ€çš„ <code>Scan Response</code> å¤„ç†æµç¨‹ï¼Œæˆ‘åœ¨ä»£ç ä¸­ç›´æ¥å°†å…¶å‘½åä¸º
<code>DeviceAnnouncement</code>ã€‚</p>
<p>å¦‚æœ header type æ˜¯ 3ï¼Œæ ¹æ®åç¼–è¯‘ç»“æœï¼Œä¼šè°ƒç”¨ <code>bl_ble_fastcon_encrty</code> å‡½æ•°è§£å¯†å‰©ä¸‹çš„æ•°æ®ï¼Œ
å¹¶æ ¹æ®è§£å¯†åçš„ç¬¬ä¸€ä¸ª byte åˆ¤æ–­å†…å®¹ç±»å‹ï¼ŒåŒ…æ‹¬ <code>TimerUploadResponse</code> å’Œ <code>HeartBeat</code>ã€‚</p>
<p>ä¼¼ä¹æ²¡æœ‰å…¶ä»–çš„ header type äº†ã€‚</p>
<hr>
<h2 id="bl_ble_fastcon_header_encrty-ä¸-bl_ble_fastcon_encrty">
  bl_ble_fastcon_header_encrty ä¸ bl_ble_fastcon_encrty
  <a class="heading-link" href="#bl_ble_fastcon_header_encrty-%e4%b8%8e-bl_ble_fastcon_encrty">
    <i class="fa-solid fa-link" aria-hidden="true" title="é“¾æ¥åˆ°æ ‡é¢˜"></i>
    <span class="sr-only">é“¾æ¥åˆ°æ ‡é¢˜</span>
  </a>
</h2>
<p>æ¥ä¸‹æ¥éœ€è¦é€†å‘å‡º <code>bl_ble_fastcon_header_encrty</code> å’Œ <code>bl_ble_fastcon_encrty</code> å‡½æ•°çš„é€»è¾‘ã€‚</p>
<p><img alt="decrypt-1-binja" src="/posts/2023-04/reverse-the-fastcon-ble-protocol-2/decrypt-1-binja.png"></p>
<p>çœ‹åˆ°è¿™é‡Œå‡ºç°äº† v å¯„å­˜å™¨ï¼Œäºæ˜¯åˆç†çŒœæµ‹æ˜¯ä¸€ä¸ª SIMD ä¼˜åŒ–è¿‡çš„å¾ªç¯ã€‚</p>
<p>å› ä¸ºåœ¨ç¼–è¯‘å™¨è¿›è¡Œ SIMD ä¼˜åŒ–æ—¶ï¼Œä¸ä¼šå‡è®¾ã€Œæ‰€æœ‰çš„æ•°æ®å‡èƒ½è¢«ã€ SIMD æŒ‡ä»¤å¤„ç†ã€‚
å› æ­¤åœ¨ SIMD æŒ‡ä»¤å‰åæ€»ä¼šå‡ºç°å¦ä¸€å¾ªç¯ï¼Œç”¨æ¥å¤„ç†å‰©ä½™çš„æ•°æ®ï¼Œå¹¶ä¸”æ•ˆæœåº”ä¸ SIMD æŒ‡ä»¤ç›¸åŒã€‚</p>
<p>ï¼ˆæ‰€ä»¥åªçœ‹å¦ä¸€éƒ¨åˆ†é SIMD çš„å¾ªç¯ï¼Œä¹Ÿèƒ½å¾—åˆ°æ­£ç¡®çš„ç»“æœï¼‰</p>
<p><img alt="decrypt-non-simd" src="/posts/2023-04/reverse-the-fastcon-ble-protocol-2/decrpyt-1-non-simd.png"></p>
<p>åœ¨è¿™é‡Œï¼Œæˆ‘çœ‹åˆ°äº†â€¦â€¦</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ff79c6">do</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">*</span>(<span style="color:#8be9fd">int8_t</span><span style="color:#ff79c6">*</span>)((<span style="color:#8be9fd">char</span><span style="color:#ff79c6">*</span>)arg2 <span style="color:#ff79c6">+</span> x9_1) <span style="color:#ff79c6">=</span>
</span></span><span style="display:flex;"><span>        (HEADER_XOR_KEY[(x9_1 <span style="color:#ff79c6">&amp;</span> <span style="color:#bd93f9">3</span>)] <span style="color:#ff79c6">^</span> <span style="color:#ff79c6">*</span>(<span style="color:#8be9fd">int8_t</span><span style="color:#ff79c6">*</span>)((<span style="color:#8be9fd">char</span><span style="color:#ff79c6">*</span>)arg1 <span style="color:#ff79c6">+</span> x9_1));
</span></span><span style="display:flex;"><span>    x9_1 <span style="color:#ff79c6">=</span> (x9_1 <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span>);
</span></span><span style="display:flex;"><span>} <span style="color:#ff79c6">while</span> (x8_1 <span style="color:#ff79c6">!=</span> x9_1);
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç”±æ­¤å¯çŸ¥ <code>x9_1</code> ç±»ä¼¼ä¸€ä¸ªè®¡æ•°å™¨ï¼Œé‚£ä¹ˆæ ¹æ®ä¸€èˆ¬ç»éªŒï¼Œ<code>x8_1</code> æ—¢ç„¶æ˜¯è¦å’Œ <code>x9_1</code> æ¯”è¾ƒçš„è¯ï¼Œ
å®ƒå°±åº”è¯¥æ˜¯å‰©ä½™ï¼ˆå› ä¸º SIMD ä»£ç <strong>å¯èƒ½</strong>å·²ç»å¤„ç†ä¸€éƒ¨åˆ†äº†ï¼‰æ•°æ®çš„é•¿åº¦ã€‚</p>
<p>æœä¸å…¶ç„¶ï¼Œåœ¨ä¸Šé¢å°±æœ‰ <code>uint64_t x8_1 = ((uint64_t)arg3);</code> è¿™æ ·çš„è¯­å¥ã€‚</p>
<p>æˆ‘å·²ç»çŸ¥é“å‡½æ•°çš„ <code>arg1</code> çš„ç±»å‹æ˜¯ <code>const u8 *</code>ï¼Œä¹Ÿå°±æ˜¯è¾“å…¥æ•°æ®ï¼Œ<code>arg2</code> çš„ç±»å‹æ˜¯ <code>u8 *</code>ï¼Œ
ä¹Ÿå°±æ˜¯è¾“å‡ºæ•°æ®ï¼Œé‚£ä¹ˆå°±ä¸éš¾çœ‹å‡ºè¿™æ®µå¾ªç¯çš„ä½œç”¨äº†ã€‚</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ff79c6">for</span> (<span style="color:#8be9fd">int</span> i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>; i <span style="color:#ff79c6">&lt;</span> data_len; i<span style="color:#ff79c6">++</span>) {
</span></span><span style="display:flex;"><span>    out[i] <span style="color:#ff79c6">=</span> data[i] <span style="color:#ff79c6">^</span> HEADER_XOR_KEY[i <span style="color:#ff79c6">&amp;</span> <span style="color:#bd93f9">3</span>];
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è‡³æ­¤ï¼Œè¿™ä¸ªå‡½æ•°é€»è¾‘å°±å¾ˆæ¸…æ™°äº†ï¼Œä»…ä»…æ˜¯ä¸€ä¸ªç®€å•çš„å¼‚æˆ–è¿ç®—ã€‚</p>
<hr>
<h3 id="bl_ble_fastcon_encrty">
  bl_ble_fastcon_encrty
  <a class="heading-link" href="#bl_ble_fastcon_encrty">
    <i class="fa-solid fa-link" aria-hidden="true" title="é“¾æ¥åˆ°æ ‡é¢˜"></i>
    <span class="sr-only">é“¾æ¥åˆ°æ ‡é¢˜</span>
  </a>
</h3>
<p>æœ‰äº†ä¸Šä¸€å‡½æ•°çš„ç»éªŒï¼Œè¿™ä¸ªå‡½æ•°å°±å¾ˆç®€å•äº†ã€‚</p>
<p>åŒæ ·æ˜¯ä¸€ä¸ª v å¯„å­˜å™¨ï¼Œä»£è¡¨ç€ SIMD ä¼˜åŒ–è¿‡çš„å¾ªç¯ï¼ŒåŒæ ·æ˜¯ goto åˆ°äº†å¦ä¸€ä¸ª &ldquo;å¹³å‡¡&rdquo; çš„å¾ªç¯ã€‚</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">label_15914</span>:
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">do</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    arg2[x9_1] <span style="color:#ff79c6">=</span> (<span style="color:#ff79c6">*</span>(<span style="color:#8be9fd">int8_t</span><span style="color:#ff79c6">*</span>)((<span style="color:#8be9fd">char</span><span style="color:#ff79c6">*</span>)arg4 <span style="color:#ff79c6">+</span> (x9_1 <span style="color:#ff79c6">&amp;</span> <span style="color:#bd93f9">3</span>)) <span style="color:#ff79c6">^</span> arg1[x9_1]);
</span></span><span style="display:flex;"><span>    x9_1 <span style="color:#ff79c6">=</span> (x9_1 <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span>);
</span></span><span style="display:flex;"><span>} <span style="color:#ff79c6">while</span> (x8_1 <span style="color:#ff79c6">!=</span> x9_1);
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç¨å¾®ä¸åŒçš„æ˜¯ï¼Œè¿™é‡Œæˆ‘ä»¬æ²¡æœ‰ <code>HEADER_XOR_KEY</code>ï¼Œè€Œæ˜¯æœ‰ä¸€ä¸ª <code>arg4</code>ã€‚</p>
<p>åœ¨ä¸ç»æ„é—´ç¿»çœ‹çš„æ—¶å€™ï¼Œå‘ç°äº† C++ é‡Œæ‰ä¼šæœ‰çš„ <code>std::</code> å‘½åç©ºé—´ï¼Œè¿™æ‰å‘ç°
åŸæ¥è¿™ä¸ªåº“æ˜¯ç”¨ C++ å†™çš„ã€‚</p>
<p>äºæ˜¯æˆ‘å°è¯•åœ¨ Binja ä¸­æ˜¾ç¤ºå‡½æ•° mangle åçš„åå­—ï¼Œå‘ç°æ˜¯ <code>_Z21bl_ble_fastcon_encrtyPhS_iS_</code>ï¼Œ
é‚£ä¹ˆï¼š</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ c++filt <span style="color:#f1fa8c">&#39;_Z21bl_ble_fastcon_encrtyPhS_iS_&#39;</span>
</span></span><span style="display:flex;"><span>bl_ble_fastcon_encrty<span style="color:#ff79c6">(</span>unsigned char*, unsigned char*, int, unsigned char*<span style="color:#ff79c6">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æˆ‘ä»¬å°±å¯ä»¥å¯é åœ°å¾—çŸ¥ <code>arg4</code> çš„ç±»å‹æ˜¯ <code>const u8 *</code>ï¼Œä¹Ÿå°±æ˜¯è§£å¯†æ‰€éœ€çš„ keyã€‚</p>
<p>é‚£ä¹ˆè¿™ä¸ªå‡½æ•°å°±ä¹Ÿè¢«æˆåŠŸé€†å‘äº†ã€‚</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#6272a4">// æˆ‘å†™ä»£ç æ‰ä¸ä¼šç”¨è¿™æ ·çš„æ ¼å¼â€¦â€¦
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">// è¿˜ä¸æ˜¯ä¸ºäº†ç…§é¡¾çª„å±ç”¨æˆ·
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#8be9fd">void</span> <span style="color:#50fa7b">bl_ble_fastcon_encrty</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">const</span> u8 <span style="color:#ff79c6">*</span>src,
</span></span><span style="display:flex;"><span>    u8 <span style="color:#ff79c6">*</span>dst,
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">size_t</span> size,
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">const</span> u8 <span style="color:#ff79c6">*</span>key
</span></span><span style="display:flex;"><span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> (<span style="color:#8be9fd">size_t</span> i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>; i <span style="color:#ff79c6">&lt;</span> size; i<span style="color:#ff79c6">++</span>)
</span></span><span style="display:flex;"><span>        dst[i] <span style="color:#ff79c6">=</span> key[i <span style="color:#ff79c6">&amp;</span> <span style="color:#bd93f9">3</span>] <span style="color:#ff79c6">^</span> src[i];
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="java-å¯¹åº”è°ƒç”¨æ–¹çš„é‡æ–°å®ç°">
  Java å¯¹åº”è°ƒç”¨æ–¹çš„é‡æ–°å®ç°
  <a class="heading-link" href="#java-%e5%af%b9%e5%ba%94%e8%b0%83%e7%94%a8%e6%96%b9%e7%9a%84%e9%87%8d%e6%96%b0%e5%ae%9e%e7%8e%b0">
    <i class="fa-solid fa-link" aria-hidden="true" title="é“¾æ¥åˆ°æ ‡é¢˜"></i>
    <span class="sr-only">é“¾æ¥åˆ°æ ‡é¢˜</span>
  </a>
</h2>
<p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç”±äºæˆ‘çš„æœ€ç»ˆç›®æ ‡æ˜¯å†™ä¸€ä¸ª Rust åº“ï¼Œæ‰€ä»¥ç°é˜¶æ®µéœ€è¦åšçš„å°±æ˜¯ç›´æ¥å°† Java
åç¼–è¯‘åçš„ä»£ç ä½¿ç”¨ Rust é‡æ–°å®ç°ä¸€ä¸‹å³å¯ã€‚</p>
<h3 id="1-java-æ–¹é¢çš„å‚æ•°">
  1. Java æ–¹é¢çš„å‚æ•°
  <a class="heading-link" href="#1-java-%e6%96%b9%e9%9d%a2%e7%9a%84%e5%8f%82%e6%95%b0">
    <i class="fa-solid fa-link" aria-hidden="true" title="é“¾æ¥åˆ°æ ‡é¢˜"></i>
    <span class="sr-only">é“¾æ¥åˆ°æ ‡é¢˜</span>
  </a>
</h3>
<p>æ¥ä¸‹æ¥è¯·æ¬£èµåç¼–è¯‘åçš„ Java å‡½æ•°å‚æ•°åï¼š</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> String <span style="color:#50fa7b">genSingleLightCommand</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">boolean</span> z, <span style="color:#8be9fd">int</span> i, <span style="color:#8be9fd">int</span> i2, <span style="color:#8be9fd">int</span> i3, <span style="color:#8be9fd">int</span> i4, <span style="color:#8be9fd">int</span> i5, <span style="color:#8be9fd">int</span> i6,
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">int</span> i7
</span></span><span style="display:flex;"><span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> genSingleLightCommand(
</span></span><span style="display:flex;"><span>        z, i, i2, i3, i4, i5, i6, i7, <span style="color:#ff79c6">false</span>
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> String <span style="color:#50fa7b">genSingleLightCommand</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">boolean</span> z, <span style="color:#8be9fd">int</span> i, <span style="color:#8be9fd">int</span> i2, <span style="color:#8be9fd">int</span> i3, <span style="color:#8be9fd">int</span> i4, <span style="color:#8be9fd">int</span> i5, <span style="color:#8be9fd">int</span> i6,
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">int</span> i7, <span style="color:#8be9fd">boolean</span> z2
</span></span><span style="display:flex;"><span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> genSingleLightCommand(
</span></span><span style="display:flex;"><span>        z, i, i2, i3, i4, i5, i6, <span style="color:#ff79c6">true</span>, 255, i7, z2
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> String <span style="color:#50fa7b">genSingleLightCommand</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">boolean</span> z, <span style="color:#8be9fd">int</span> i, <span style="color:#8be9fd">int</span> i2, <span style="color:#8be9fd">int</span> i3, <span style="color:#8be9fd">int</span> i4, <span style="color:#8be9fd">int</span> i5, <span style="color:#8be9fd">int</span> i6,
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">boolean</span> z2, <span style="color:#8be9fd">int</span> i7, <span style="color:#8be9fd">int</span> i8, <span style="color:#8be9fd">boolean</span> z3
</span></span><span style="display:flex;"><span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> genSingleLightCommand(
</span></span><span style="display:flex;"><span>        z, i, i2, i3, i4, i5, i6, z2, i7, i8, z3, <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> String <span style="color:#50fa7b">genSingleLightCommand</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">boolean</span> z, <span style="color:#8be9fd">int</span> i, <span style="color:#8be9fd">int</span> i2, <span style="color:#8be9fd">int</span> i3, <span style="color:#8be9fd">int</span> i4, <span style="color:#8be9fd">int</span> i5, <span style="color:#8be9fd">int</span> i6,
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">boolean</span> z2, <span style="color:#8be9fd">int</span> i7, <span style="color:#8be9fd">int</span> i8, <span style="color:#8be9fd">boolean</span> z3, <span style="color:#8be9fd">boolean</span> z4
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></td></tr></table>
</div>
</div><p>çœ‹åˆ°è¿™æ ·çš„å‡½æ•°é‡è½½å’Œå‚æ•°ï¼Œ<del>å½“æ—¶äººå°±å‚»æ‰</del>ã€‚ä»…æœ‰çš„æ–¹æ¡ˆå°±æ˜¯ä¸€ç‚¹ä¸€ç‚¹ç”¨ rust é‡å†™ï¼Œ
å¹¶æ— å…¶ä»–æ·å¾„ã€‚</p>
<hr>
<p><strong>äºæ˜¯å†³å®šè·³è¿‡è¿™æ®µæ— èŠçš„é‡å†™ï¼Œç›´æ¥å…³æ³¨ native åº“çš„é€†å‘è¿‡ç¨‹ã€‚</strong></p>
<hr>
<h2 id="å†æ¬¡é€†å‘-native-åº“">
  ï¼ˆå†æ¬¡ï¼‰é€†å‘ native åº“
  <a class="heading-link" href="#%e5%86%8d%e6%ac%a1%e9%80%86%e5%90%91-native-%e5%ba%93">
    <i class="fa-solid fa-link" aria-hidden="true" title="é“¾æ¥åˆ°æ ‡é¢˜"></i>
    <span class="sr-only">é“¾æ¥åˆ°æ ‡é¢˜</span>
  </a>
</h2>
<p>æ•´ä¸ª native åº“å››åå¤šä¸ª JNI å‡½æ•°ï¼Œåœ¨ä¸Šæ–‡ä»…å‡ºç°äº†ä¸€ä¸ªã€‚å› ä¸ºå¥½æˆè¿˜åœ¨åå¤´ï¼š</p>
<p>å°±æ‹¿ç”¨äºæ§åˆ¶å•ä¸ªç­‰å¼€å…³çš„å‡½æ•° <code>singleOnOff</code> ä¸ºä¾‹ï¼Œä»å°è£…å‡½æ•°å¼€å§‹ï¼Œåˆ°æœ€ç»ˆæ•°æ®è¢«å¹¿æ’­å‡ºå»ï¼š</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#6272a4">/*Java*/</span> Helper.<span style="color:#50fa7b">singleOnOff</span>(<span style="color:#8be9fd">int</span> i, <span style="color:#8be9fd">boolean</span> z);
</span></span><span style="display:flex;"><span><span style="color:#6272a4">/*Java*/</span> Helper.<span style="color:#50fa7b">singleControl</span>(<span style="color:#8be9fd">int</span> i, String data);
</span></span><span style="display:flex;"><span><span style="color:#6272a4">/*Java*/</span> BLSBleLight.<span style="color:#50fa7b">controlWithDevice</span>(<span style="color:#8be9fd">int</span> i, String data, <span style="color:#8be9fd">int</span> delay);
</span></span><span style="display:flex;"><span><span style="color:#6272a4">/*Java*/</span> BLEFastconHelper.<span style="color:#50fa7b">controlLightSingle</span>(<span style="color:#8be9fd">int</span> i, String data, <span style="color:#8be9fd">int</span> delay);
</span></span><span style="display:flex;"><span><span style="color:#6272a4">/*C++ */</span> package_device_control(<span style="color:#8be9fd">int</span>, <span style="color:#8be9fd;font-style:italic">const</span> <span style="color:#8be9fd">char</span> <span style="color:#ff79c6">*</span>, <span style="color:#8be9fd">int</span>, <span style="color:#8be9fd">char</span> <span style="color:#ff79c6">*</span>); <span style="color:#6272a4">// æ‰“åŒ…è®¾å¤‡æ§åˆ¶æŒ‡ä»¤</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">/*Java*/</span> BLEFastconHelper.<span style="color:#50fa7b">sendCommand</span>(<span style="color:#8be9fd">int</span>, <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span>, <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span>, ...);
</span></span><span style="display:flex;"><span><span style="color:#6272a4">/*Java*/</span> BLEFastconHelper.<span style="color:#50fa7b">sendCommand</span>(<span style="color:#8be9fd">int</span>, <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span>, <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span>, ...);
</span></span><span style="display:flex;"><span><span style="color:#6272a4">/*Java*/</span> BLEFastconHelper.<span style="color:#50fa7b">doSendCommand</span>(<span style="color:#8be9fd">int</span>, <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span>, <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span>, ...);
</span></span><span style="display:flex;"><span><span style="color:#6272a4">/*Java*/</span> BLEFastconHelper.<span style="color:#50fa7b">getPayloadWithInnerRetry</span>(<span style="color:#8be9fd">int</span>, <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span>, <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span>,);
</span></span><span style="display:flex;"><span><span style="color:#6272a4">/*C++ */</span> package_ble_fastcon_body(<span style="color:#8be9fd">int</span>, <span style="color:#8be9fd">int</span>, <span style="color:#8be9fd">int</span>, <span style="color:#8be9fd">int</span>, <span style="color:#8be9fd">int</span>, <span style="color:#8be9fd">char</span> <span style="color:#ff79c6">*</span>, <span style="color:#8be9fd">int</span>, <span style="color:#8be9fd">char</span> <span style="color:#ff79c6">*</span>, <span style="color:#8be9fd">char</span> <span style="color:#ff79c6">*</span>);
</span></span><span style="display:flex;"><span><span style="color:#6272a4">/*Java*/</span> BLEFastconHelper.<span style="color:#50fa7b">XdoSendCommand</span>(<span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span>, <span style="color:#8be9fd">int</span>, <span style="color:#8be9fd">boolean</span>, <span style="color:#8be9fd">boolean</span>, <span style="color:#8be9fd">boolean</span>);
</span></span><span style="display:flex;"><span><span style="color:#6272a4">/*C++ */</span> get_rf_payload(<span style="color:#8be9fd">char</span> <span style="color:#ff79c6">*</span>, <span style="color:#8be9fd">int</span>, <span style="color:#8be9fd">char</span> <span style="color:#ff79c6">*</span>, <span style="color:#8be9fd">int</span>, <span style="color:#8be9fd">char</span> <span style="color:#ff79c6">*</span>); <span style="color:#6272a4">// è·å– RF payload</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">/*Java*/</span> BluetoothLeAdvertiser.<span style="color:#50fa7b">startAdvertising</span>(...); <span style="color:#6272a4">// ç»ˆäºæŠŠæ•°æ®å‘å‡ºå»äº†</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å…¶ä¸­æ¶‰åŠäº†ä¸‰æ¬¡ native è°ƒç”¨ï¼Œé‚£ä¹ˆå°±ä»ç¬¬ä¸€ä¸ªå¼€å§‹åšå§ã€‚</p>
<h2 id="1-package_device_control">
  1. package_device_control
  <a class="heading-link" href="#1-package_device_control">
    <i class="fa-solid fa-link" aria-hidden="true" title="é“¾æ¥åˆ°æ ‡é¢˜"></i>
    <span class="sr-only">é“¾æ¥åˆ°æ ‡é¢˜</span>
  </a>
</h2>
<p>çœ‹åå­—åº”è¯¥æ˜¯ç”¨äº ã€Œæ‰“åŒ…è®¾å¤‡æ§åˆ¶æŒ‡ä»¤ã€ï¼Œé¦–å…ˆæ‰“å¼€ Binjaï¼Œæ‰¾åˆ°å¯¹åº”çš„ JNI å…¥å£ï¼š</p>
<p><img alt="package_device_control" src="/posts/2023-04/reverse-the-fastcon-ble-protocol-2/package_device_control.png"></p>
<p>ä¹ä¸€çœ‹ï¼Œè¿™ä¸ªå‡½æ•°æ€ä¹ˆè¿™ä¹ˆçŸ­ï¼Ÿ</p>
<p>ä»”ç»†è§‚å¯Ÿæ‰å‘ç°è¿™åªæ˜¯ä¸€ä¸ª wrapperï¼Œå¤§æ¦‚åšçš„å°±æ˜¯å…ˆ <code>malloc</code> å‡ºä¸€ä»½å·¥ä½œç”¨çš„ bufferï¼Œè®²ä¼ å…¥çš„ <code>JByteArray</code>
å†…å®¹è§£åŒ…åˆ° buffer é‡Œï¼Œéšåè°ƒç”¨çœŸæ­£çš„å‡½æ•°ï¼Œæœ€åå°† buffer é‡Œçš„å†…å®¹æ‰“åŒ…åˆ°è¿”å›ç”¨çš„ <code>JByteArray</code> é‡Œã€‚</p>
<p>å¹¶æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«çš„åœ°æ–¹ï¼Œé‚è·³åˆ°çœŸæ­£çš„å‡½æ•° <code>package_device_control</code> å»ä¸€æ¢ç©¶ç«Ÿï¼š</p>
<p><img alt="package_device_control-real" src="/posts/2023-04/reverse-the-fastcon-ble-protocol-2/package_device_control-real.png"></p>
<p>å‡½æ•°çš„å¼€å¤´å’Œæœ€åå‡ è¡Œé€šå¸¸æ˜¯ stack smashing protectorï¼Œä¸æˆ‘ä»¬æ— å…³ï¼Œæ‰€ä»¥åªéœ€è¦å…³æ³¨ä¸­é—´çš„éƒ¨åˆ†ï¼š</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8be9fd">uint64_t</span> len_add_1 <span style="color:#ff79c6">=</span> ((<span style="color:#8be9fd">uint64_t</span>)(src_len <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span>));
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">*</span>(<span style="color:#8be9fd">int8_t</span><span style="color:#ff79c6">*</span>)result <span style="color:#ff79c6">=</span> (<span style="color:#bd93f9">2</span> <span style="color:#ff79c6">|</span> ((<span style="color:#8be9fd">int8_t</span>)((<span style="color:#bd93f9">0xfffffff</span> <span style="color:#ff79c6">&amp;</span> len_add_1) <span style="color:#ff79c6">&lt;&lt;</span> <span style="color:#bd93f9">4</span>)));
</span></span><span style="display:flex;"><span>result[<span style="color:#bd93f9">1</span>] <span style="color:#ff79c6">=</span> device_id;
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">memcpy</span>(<span style="color:#ff79c6">&amp;</span>result[<span style="color:#bd93f9">2</span>], src_buf, ((<span style="color:#8be9fd">int64_t</span>)src_len));
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">char</span> x10_1 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span><span style="color:#f1fa8c">&#34;0123456789abcdef&#34;</span>[(len_add_1 <span style="color:#ff79c6">&amp;</span> <span style="color:#bd93f9">0xf</span>)];
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">int32_t</span> x9_1 <span style="color:#ff79c6">=</span> (len_add_1 <span style="color:#ff79c6">&amp;</span> <span style="color:#bd93f9">0xf</span>);
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">int128_t</span> v0;
</span></span><span style="display:flex;"><span>v0 <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">char</span> var_c0[<span style="color:#bd93f9">0x12</span>];
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">__builtin_memset</span>(var_c0[<span style="color:#bd93f9">0</span>], <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">0x80</span>);
</span></span><span style="display:flex;"><span>var_c0[<span style="color:#bd93f9">0</span>] <span style="color:#ff79c6">=</span> x10_1;
</span></span><span style="display:flex;"><span>var_c0[<span style="color:#bd93f9">1</span>] <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0x32</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">if</span> (x9_1 <span style="color:#ff79c6">!=</span> <span style="color:#bd93f9">0</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">int32_t</span> x9_2 <span style="color:#ff79c6">=</span> x9_1;
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">char</span><span style="color:#ff79c6">*</span> x10_2 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>result[<span style="color:#bd93f9">1</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">void</span><span style="color:#ff79c6">*</span> x11_1 <span style="color:#ff79c6">=</span> (<span style="color:#ff79c6">&amp;</span>var_c0 <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">3</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">int32_t</span> temp0_1;
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">do</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">char</span> c <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(<span style="color:#8be9fd">int8_t</span><span style="color:#ff79c6">*</span>)x10_2;
</span></span><span style="display:flex;"><span>        x10_2 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>x10_2[<span style="color:#bd93f9">1</span>];
</span></span><span style="display:flex;"><span>        temp0_1 <span style="color:#ff79c6">=</span> x9_2;
</span></span><span style="display:flex;"><span>        x9_2 <span style="color:#ff79c6">=</span> (x9_2 <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">1</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">char</span> cc <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span><span style="color:#f1fa8c">&#34;0123456789abcdef&#34;</span>[(c <span style="color:#ff79c6">&amp;</span> <span style="color:#bd93f9">0xf</span>)];
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">*</span>(<span style="color:#8be9fd">int8_t</span><span style="color:#ff79c6">*</span>)((<span style="color:#8be9fd">char</span><span style="color:#ff79c6">*</span>)x11_1 <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">1</span>) <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span><span style="color:#f1fa8c">&#34;0123456789abcdef&#34;</span>[(c <span style="color:#ff79c6">&gt;&gt;</span> <span style="color:#bd93f9">4</span>)];
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">*</span>(<span style="color:#8be9fd">int8_t</span><span style="color:#ff79c6">*</span>)x11_1 <span style="color:#ff79c6">=</span> cc;
</span></span><span style="display:flex;"><span>        x11_1 <span style="color:#ff79c6">=</span> ((<span style="color:#8be9fd">char</span><span style="color:#ff79c6">*</span>)x11_1 <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">2</span>);
</span></span><span style="display:flex;"><span>    } <span style="color:#ff79c6">while</span> (temp0_1 <span style="color:#ff79c6">!=</span> <span style="color:#bd93f9">1</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">__android_log_print</span>(<span style="color:#bd93f9">4</span>, <span style="color:#f1fa8c">&#34;jyq_jni&#34;</span>, <span style="color:#f1fa8c">&#34;package_device_control output: %s...&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&amp;</span>var_c0, ((<span style="color:#8be9fd">uint64_t</span>)device_id));
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™æ®µä»£ç æœ€åè°ƒç”¨äº† <code>__android_log_print</code>ï¼Œé‚£ä¹ˆå‚æ•° <code>var_c0</code> å°±ä¸€å®šæ˜¯æŸä¸ªå­—ç¬¦ä¸²ï¼Œçœ‹æ¥çœ‹å»ï¼Œä¼¼ä¹è¿™æ•´ä¸ªä¸²
ä¸æˆ‘ä»¬çš„å®é™…æ“ä½œæ¯«æ— å…³ç³»ï¼Œäºæ˜¯æŠŠä»£ç æ‰”åˆ°ç¼–è¾‘å™¨é‡Œï¼Œä¸€ä¸ªä¸€ä¸ªåˆ å˜é‡ï¼Œè®© Language Server çš„æŠ¥é”™æ¥å¸®å¿™ï¼š</p>
<p>æœ€ç»ˆä¸€ä¸ªä¸ªåˆ å®Œï¼Œåªå‰©ä¸‹äº†è¿™å››è¡Œä»£ç ï¼š</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8be9fd">uint64_t</span> len_add_1 <span style="color:#ff79c6">=</span> ((<span style="color:#8be9fd">uint64_t</span>)(src_len <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span>));
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">*</span>(<span style="color:#8be9fd">int8_t</span><span style="color:#ff79c6">*</span>)result <span style="color:#ff79c6">=</span> (<span style="color:#bd93f9">2</span> <span style="color:#ff79c6">|</span> ((<span style="color:#8be9fd">int8_t</span>)((<span style="color:#bd93f9">0xfffffff</span> <span style="color:#ff79c6">&amp;</span> len_add_1) <span style="color:#ff79c6">&lt;&lt;</span> <span style="color:#bd93f9">4</span>)));
</span></span><span style="display:flex;"><span>result[<span style="color:#bd93f9">1</span>] <span style="color:#ff79c6">=</span> device_id;
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">memcpy</span>(<span style="color:#ff79c6">&amp;</span>result[<span style="color:#bd93f9">2</span>], src_buf, ((<span style="color:#8be9fd">int64_t</span>)src_len));
</span></span></code></pre></td></tr></table>
</div>
</div><p>çœ‹æ¥è¿™ä¸ª result çš„ç¬¬ä¸€ä¸ª byte æ˜¯é•¿åº¦ + 1 å·¦ç§»å››ä½åä¸ 2 å–æŒ‰ä½æˆ–ï¼Œç¬¬äºŒä¸ª byte æ˜¯è®¾å¤‡ idï¼Œåé¢çš„å†…å®¹
å°±æ˜¯æˆ‘ä»¬ä¼ å…¥çš„æ•°æ®äº†ã€‚</p>
<p>ï¼ˆæ€ä¹ˆè¿™ä¹ˆç®€å•ï¼Ÿï¼‰</p>
<h2 id="2-package_ble_fastcon_body">
  2. package_ble_fastcon_body
  <a class="heading-link" href="#2-package_ble_fastcon_body">
    <i class="fa-solid fa-link" aria-hidden="true" title="é“¾æ¥åˆ°æ ‡é¢˜"></i>
    <span class="sr-only">é“¾æ¥åˆ°æ ‡é¢˜</span>
  </a>
</h2>
<p>æœ‰äº†ä¸Šä¸ªå‡½æ•°çš„ &ldquo;ç»éªŒ&rdquo;ï¼Œæˆ‘å…´å†²å†²æ‰“å¼€äº†è¿™ä¸ªå‡½æ•°ä½“ã€‚</p>
<p>JNI å…¥å£å‡½æ•°ä»ç„¶æ˜¯ååˆ†ç±»ä¼¼çš„ wrapperï¼Œé¦–å…ˆ <code>malloc</code> äº†ä¸€ä»½ bufferï¼Œç„¶åè°ƒç”¨çœŸæ­£çš„å‡½æ•°ï¼Œæœ€åå°† buffer
é‡æ–°æ‰“åŒ…åˆ°è¿”å›ç”¨çš„ <code>JByteArray</code> é‡Œï¼Œäºæ˜¯ç›´æ¥å‰å¾€çœŸæ­£çš„å‡½æ•°ä½“ï¼š<code>package_ble_fastcon_body</code>ã€‚</p>
<p>è¿™ä¸ªå‡½æ•°æ¯”ä¸Šä¸€ä¸ªé•¿å¾ˆå¤šï¼Œè€Œä¸”é‡Œé¢æœ‰å¾ˆå¤šçš„ä¸ä¸Šä¸ªå‡½æ•°å†…ç±»ä¼¼çš„ <code>bytes-to-hex-string</code> ä»£ç ï¼š</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#6272a4">// bytes-to-hex-string å¤§æ¦‚é•¿è¿™æ ·ï¼š
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">// å…¶ä¸­ï¼Œx19 æ˜¯æŸäº› char æŒ‡é’ˆï¼Œx9_12 ä¼¼ä¹æ˜¯ä¸€ä¸ªè®¡æ•°å™¨
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">// x8_12 åˆ™åº”è¯¥æ˜¯æŒ‡å‘ hex-string çš„æŒ‡é’ˆ
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">// å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œçš„å¾ªç¯ä¼¼ä¹æ˜¯ä¸¤ bytes ä¸ºä¸€ç»„èµ‹å€¼ï¼Œæ‰€ä»¥ x8_12 ä¼šæ¯æ¬¡å¢åŠ  2
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">// ï¼ˆä¸è¿‡è¿™ä¸æˆ‘ä»¬çš„å®é™…æ“ä½œæ¯«æ— å…³ç³»ï¼Œåªæ˜¯é¡ºä¾¿è¯´è¯´ï¼‰
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">do</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">uint64_t</span> x10_16 <span style="color:#ff79c6">=</span> ((<span style="color:#8be9fd">uint64_t</span>)<span style="color:#ff79c6">*</span>(<span style="color:#8be9fd">int8_t</span><span style="color:#ff79c6">*</span>)x19);
</span></span><span style="display:flex;"><span>    x19 <span style="color:#ff79c6">=</span> ((<span style="color:#8be9fd">char</span><span style="color:#ff79c6">*</span>)x19 <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span>);
</span></span><span style="display:flex;"><span>    temp2_1 <span style="color:#ff79c6">=</span> x9_12;
</span></span><span style="display:flex;"><span>    x9_12 <span style="color:#ff79c6">=</span> (x9_12 <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">1</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">char</span> x10_18 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span><span style="color:#f1fa8c">&#34;0123456789abcdef&#34;</span>[(x10_16 <span style="color:#ff79c6">&amp;</span> <span style="color:#bd93f9">0xf</span>)];
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">*</span>(<span style="color:#8be9fd">int8_t</span><span style="color:#ff79c6">*</span>)x8_12 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span><span style="color:#f1fa8c">&#34;0123456789abcdef&#34;</span>[(x10_16 <span style="color:#ff79c6">&gt;&gt;</span> <span style="color:#bd93f9">4</span>)];
</span></span><span style="display:flex;"><span>    x8_12[<span style="color:#bd93f9">1</span>] <span style="color:#ff79c6">=</span> x10_18;
</span></span><span style="display:flex;"><span>    x8_12 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>x8_12[<span style="color:#bd93f9">2</span>];
</span></span><span style="display:flex;"><span>} <span style="color:#ff79c6">while</span> (temp2_1 <span style="color:#ff79c6">!=</span> <span style="color:#bd93f9">1</span>);
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨æœ¬å‡½æ•°ä½“å†…ï¼Œç±»ä¼¼çš„ä»£ç å‡ºç°äº†å››æ¬¡ï¼Œå…¶ä¸­ä¸¤æ¬¡å¾ªç¯åéƒ½è·Ÿæœ‰ <code>__android_log_print</code>ï¼Œæ‰€ä»¥æˆ‘å¤§èƒ†è®¾æƒ³
è¿™äº›ä»£ç éƒ½ä¸å®é™…æ“ä½œæ— å…³ã€‚ï¼ˆ<del>å¦å¤–ä¸¤æ¬¡ä¸ºä»€ä¹ˆæ²¡ <code>print</code> æˆ‘æš‚ä¸”è’™åœ¨é¼“é‡Œ</del>ï¼‰</p>
<p>ä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘åˆ¶ä½œäº†ä¸€ä¸ª headerï¼Œé‡Œé¢åŒ…å«ä¸€äº›å¸¸ç”¨çš„ <code>typedef</code>ï¼š</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#6272a4">// æ²¡ä»€ä¹ˆç‰¹åˆ«çš„ï¼Œä¹Ÿä¸éœ€è¦ä¿è¯æ­£ç¡®ï¼Œä»…ä»…æ˜¯ä¸ºäº†æ–¹ä¾¿
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">typedef</span> <span style="color:#8be9fd">signed</span> <span style="color:#8be9fd">char</span> <span style="color:#8be9fd">int8_t</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">typedef</span> <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">char</span> <span style="color:#8be9fd">uint8_t</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">typedef</span> <span style="color:#8be9fd">short</span> <span style="color:#8be9fd">int16_t</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">typedef</span> <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">short</span> <span style="color:#8be9fd">uint16_t</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">typedef</span> <span style="color:#8be9fd">int</span> <span style="color:#8be9fd">int32_t</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">typedef</span> <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span> <span style="color:#8be9fd">uint32_t</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">typedef</span> <span style="color:#8be9fd">long</span> <span style="color:#8be9fd">long</span> <span style="color:#8be9fd">int64_t</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">typedef</span> <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">long</span> <span style="color:#8be9fd">long</span> <span style="color:#8be9fd">uint64_t</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">typedef</span> <span style="color:#ff79c6">struct</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">int64_t</span> __val[<span style="color:#bd93f9">2</span>];
</span></span><span style="display:flex;"><span>} <span style="color:#8be9fd">int128_t</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">typedef</span> <span style="color:#ff79c6">struct</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">uint64_t</span> __val[<span style="color:#bd93f9">2</span>];
</span></span><span style="display:flex;"><span>} <span style="color:#8be9fd">uint128_t</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">void</span> <span style="color:#50fa7b">__android_log_print</span>(<span style="color:#8be9fd">int32_t</span> prio, <span style="color:#ff79c6">const</span> <span style="color:#8be9fd">char</span> <span style="color:#ff79c6">*</span>tag, <span style="color:#ff79c6">const</span> <span style="color:#8be9fd">char</span> <span style="color:#ff79c6">*</span>fmt, ...);
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™æ ·æ¯æ¬¡ copy å‡ºæ¥çš„ä»£ç å°±ä¸ç”¨å†æ”¹ç±»å‹äº†ï¼Œç›´æ¥ include å¤´ã€‚</p>
<hr>
<p>å€¼å¾—è®°å½•ä¸€ä¸‹çš„æ˜¯ï¼ŒBinary Ninja å°†è¿™ä¸ªå‡½æ•°åç¼–è¯‘æˆäº†è¿™æ ·ï¼š</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8be9fd">char</span> var_100 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span><span style="color:#f1fa8c">&#34;0123456789abcdef&#34;</span>[((<span style="color:#8be9fd">uint64_t</span>) ((x24_1 <span style="color:#ff79c6">&gt;&gt;</span> <span style="color:#bd93f9">4</span>) <span style="color:#ff79c6">&amp;</span> <span style="color:#bd93f9">0xf</span>))];
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">char</span> var_ff <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span><span style="color:#f1fa8c">&#34;0123456789abcdef&#34;</span>[(x24_1 <span style="color:#ff79c6">&amp;</span> <span style="color:#bd93f9">0xf</span>)];
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">char</span> var_fe <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span><span style="color:#f1fa8c">&#34;0123456789abcdef&#34;</span>[((<span style="color:#8be9fd">uint64_t</span>) ((x26 <span style="color:#ff79c6">&gt;&gt;</span> <span style="color:#bd93f9">4</span>) <span style="color:#ff79c6">&amp;</span> <span style="color:#bd93f9">0xf</span>))];
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">char</span> var_fd <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span><span style="color:#f1fa8c">&#34;0123456789abcdef&#34;</span>[(x26 <span style="color:#ff79c6">&amp;</span> <span style="color:#bd93f9">0xf</span>)];
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">char</span> x8_6 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span><span style="color:#f1fa8c">&#34;0123456789abcdef&#34;</span>[((<span style="color:#8be9fd">uint64_t</span>) ((x25 <span style="color:#ff79c6">&gt;&gt;</span> <span style="color:#bd93f9">4</span>) <span style="color:#ff79c6">&amp;</span> <span style="color:#bd93f9">0xf</span>))];
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">char</span> x9_5 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span><span style="color:#f1fa8c">&#34;0123456789abcdef&#34;</span>[(x25 <span style="color:#ff79c6">&amp;</span> <span style="color:#bd93f9">0xf</span>)];
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">char</span> x10_6 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span><span style="color:#f1fa8c">&#34;0123456789abcdef&#34;</span>[((<span style="color:#8be9fd">uint64_t</span>) ((x23_3 <span style="color:#ff79c6">&gt;&gt;</span> <span style="color:#bd93f9">4</span>) <span style="color:#ff79c6">&amp;</span> <span style="color:#bd93f9">0xf</span>))];
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">char</span> x11_5 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span><span style="color:#f1fa8c">&#34;0123456789abcdef&#34;</span>[(x23_3 <span style="color:#ff79c6">&amp;</span> <span style="color:#bd93f9">0xf</span>)];
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">char</span> <span style="color:#ff79c6">*</span>x27 <span style="color:#ff79c6">=</span> arg9;
</span></span><span style="display:flex;"><span>v0 <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">int128_t</span> var_f8;
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">__builtin_memset</span>(var_f8, <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">0x78</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// åé¢ï¼š
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#50fa7b">__builtin_memset</span>(var_100, <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">0x80</span>);
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç»è¿‡ä¸€æ®µæ—¶é—´çš„ç ”ç©¶ï¼Œæˆ‘è®¤ä¸º <code>var_100</code> çš„å®é™…ç±»å‹åº”è¯¥æ˜¯ <code>char[0x80]</code>ï¼Œè€Œä¸Šé¢æ‰€æœ‰çš„èµ‹å€¼åº”è¯¥éƒ½æ˜¯
å¯¹è¿™ä¸ªæ•°ç»„çš„èµ‹å€¼ã€‚</p>
<hr>
<p><code>var_100</code> ä¼¼ä¹æ˜¯ä¸“é—¨ç”¨æ¥å­˜æ”¾ hex-string çš„ã€‚ä»ç„¶ä¸æˆ‘ä»¬çš„æ“ä½œæ— å…³ï¼Œæ‰€ä»¥å¹²è„†å…¨éƒ¨åˆ æ‰ã€‚å»æ‰äº†æ‰€æœ‰
SIMD æŒ‡ä»¤åï¼Œæˆ‘å¾—åˆ°äº†è¿™æ ·çš„ä»£ç ï¼š</p>
<p>ç¬¬ä¸€éƒ¨åˆ†ï¼š</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>result[<span style="color:#bd93f9">0</span>] <span style="color:#ff79c6">=</span> (<span style="color:#bd93f9">0x7f</span> <span style="color:#ff79c6">&amp;</span> ((<span style="color:#bd93f9">0x8f</span> <span style="color:#ff79c6">&amp;</span> i2) <span style="color:#ff79c6">|</span> ((<span style="color:#bd93f9">0x7</span> <span style="color:#ff79c6">&amp;</span> i) <span style="color:#ff79c6">&lt;&lt;</span> <span style="color:#bd93f9">4</span>))) <span style="color:#ff79c6">|</span> (forward <span style="color:#ff79c6">&lt;&lt;</span> <span style="color:#bd93f9">7</span>);
</span></span><span style="display:flex;"><span>result[<span style="color:#bd93f9">1</span>] <span style="color:#ff79c6">=</span> sequence;
</span></span><span style="display:flex;"><span>result[<span style="color:#bd93f9">2</span>] <span style="color:#ff79c6">=</span> safe_key;
</span></span><span style="display:flex;"><span>result[<span style="color:#bd93f9">3</span>] <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">memcpy</span>(<span style="color:#ff79c6">&amp;</span>result[<span style="color:#bd93f9">4</span>], data, data_len);
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¾ˆæ˜æ˜¾æ˜¯ä¸€äº›åŒ…å¤´çš„èµ‹å€¼ï¼Œä¸è¿‡ä¸ºä»€ä¹ˆ</p>
<p>ç¬¬äºŒéƒ¨åˆ†ï¼š</p>
<p><img alt="package_ble_fastcon_body-1" src="/posts/2023-04/reverse-the-fastcon-ble-protocol-2/package_ble_fastcon_body-1.png"></p>
<p>ç¬¬ä¸‰éƒ¨åˆ†ï¼š</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>result[<span style="color:#bd93f9">0</span>] <span style="color:#ff79c6">=</span> result[<span style="color:#bd93f9">0</span>] <span style="color:#ff79c6">^</span> <span style="color:#bd93f9">0x5e</span>;
</span></span><span style="display:flex;"><span>result[<span style="color:#bd93f9">1</span>] <span style="color:#ff79c6">=</span> sequence <span style="color:#ff79c6">^</span> <span style="color:#bd93f9">0x36</span>;
</span></span><span style="display:flex;"><span>result[<span style="color:#bd93f9">2</span>] <span style="color:#ff79c6">=</span> safe_key <span style="color:#ff79c6">^</span> <span style="color:#bd93f9">0x7b</span>;
</span></span><span style="display:flex;"><span>result[<span style="color:#bd93f9">3</span>] <span style="color:#ff79c6">=</span> x23_3 <span style="color:#ff79c6">^</span> <span style="color:#bd93f9">0xc4</span>;   <span style="color:#6272a4">// åœ¨ç¬¬äºŒéƒ¨åˆ†ç®—å‡ºçš„æŸä¸ªç»“æœ
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">char</span> <span style="color:#ff79c6">*</span>key <span style="color:#ff79c6">=</span> keyptr;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// å¦‚æœ keyptr ä¸º NULLï¼Œåˆ™ä½¿ç”¨ï¼ˆé»˜è®¤çš„ï¼‰ HEADER_XOR_KEY
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">if</span> (key <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">0</span>)
</span></span><span style="display:flex;"><span>    key <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>HEADER_XOR_KEY;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">if</span> (data_len <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">0</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// ä¸€äº› xor è¿ç®—
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">int</span> counter <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">do</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        data[counter] <span style="color:#ff79c6">=</span> key[counter <span style="color:#ff79c6">&amp;</span> <span style="color:#bd93f9">3</span>] <span style="color:#ff79c6">^</span> data[counter];
</span></span><span style="display:flex;"><span>        counter <span style="color:#ff79c6">=</span> (counter <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span>);
</span></span><span style="display:flex;"><span>    } <span style="color:#ff79c6">while</span> (data_len <span style="color:#ff79c6">!=</span> counter);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// å°† xor çš„ç»“æœå†™å…¥ result
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#50fa7b">memcpy</span>(<span style="color:#ff79c6">&amp;</span>result[<span style="color:#bd93f9">4</span>], data, data_len);
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ¥ä¸‹æ¥å·¥ä½œçš„é‡ç‚¹å°±æ˜¯ä¸ªç¬¬äºŒéƒ¨åˆ†äº†ï¼Œåœ¨ç»è¿‡{æ•°æ®æµ‹è¯•ï¼Œé˜…è¯» ASMï¼Œ<del>è¯¢é—® ChatGPT</del>}ä¹‹åï¼Œæˆ‘ç»ˆäºå¾—åˆ°äº†
è¿™æ ·çš„ç»“è®ºï¼š</p>
<ul>
<li><strong>ç¬¬äºŒéƒ¨åˆ†å…¶å®å°±æ˜¯ä¸€ä¸ª checksumï¼Œä½†ç”±äº <code>result[3]</code> æ˜¯ checksum æœ¬èº«ï¼Œæ‰€ä»¥åœ¨å¾ªç¯ sum çš„æ—¶å€™è·³è¿‡äº† <code>index = 3</code></strong></li>
</ul>
<p>é‚£ä¹ˆè¿™ä¸ªå‡½æ•°çš„é€»è¾‘å°±å¾ˆæ¸…æ™°äº†ï¼š</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#ff79c6">mut</span> body <span style="color:#ff79c6">=</span> vec![<span style="color:#bd93f9">0</span>; data.len() <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">4</span>]; <span style="color:#6272a4">// 4 bytes for header
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>body[<span style="color:#bd93f9">0</span>] <span style="color:#ff79c6">=</span> (i2 <span style="color:#ff79c6">&amp;</span> <span style="color:#bd93f9">0b1111</span>) <span style="color:#ff79c6">&lt;&lt;</span> <span style="color:#bd93f9">0</span> <span style="color:#ff79c6">|</span> (i <span style="color:#ff79c6">&amp;</span> <span style="color:#bd93f9">0b111</span>) <span style="color:#ff79c6">&lt;&lt;</span> <span style="color:#bd93f9">4</span> <span style="color:#ff79c6">|</span> <span style="color:#8be9fd">u8</span>::from(forward) <span style="color:#ff79c6">&lt;&lt;</span> <span style="color:#bd93f9">7</span>;
</span></span><span style="display:flex;"><span>body[<span style="color:#bd93f9">1</span>] <span style="color:#ff79c6">=</span> sequence <span style="color:#ff79c6">as</span> <span style="color:#8be9fd">u8</span>;
</span></span><span style="display:flex;"><span>body[<span style="color:#bd93f9">2</span>] <span style="color:#ff79c6">=</span> safe_key;
</span></span><span style="display:flex;"><span>body[<span style="color:#bd93f9">3</span>] <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>; <span style="color:#6272a4">// checksum placeholder
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>body[<span style="color:#bd93f9">4</span><span style="color:#ff79c6">..</span>].copy_from_slice(data);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#ff79c6">mut</span> checksum: <span style="color:#8be9fd">u8</span> <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> <span style="color:#bd93f9">0</span><span style="color:#ff79c6">..</span>body.len() {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> i <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">3</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">continue</span>; <span style="color:#6272a4">// skip checksum itself
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    }
</span></span><span style="display:flex;"><span>    checksum <span style="color:#ff79c6">=</span> checksum.wrapping_add(body[i]);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>body[<span style="color:#bd93f9">3</span>] <span style="color:#ff79c6">=</span> checksum;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// encrypt the header, the same as bl_ble_fastcon_header_encrty
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> <span style="color:#bd93f9">0</span><span style="color:#ff79c6">..</span><span style="color:#bd93f9">4</span> {
</span></span><span style="display:flex;"><span>    body[i] <span style="color:#ff79c6">=</span> DEFAULT_ENCRYPT_KEY[i <span style="color:#ff79c6">&amp;</span> <span style="color:#bd93f9">3</span>] <span style="color:#ff79c6">^</span> body[i];
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// encrypt the body with given key
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">let</span> real_key <span style="color:#ff79c6">=</span> key.unwrap_or(<span style="color:#ff79c6">&amp;</span>DEFAULT_ENCRYPT_KEY);
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> <span style="color:#bd93f9">0</span><span style="color:#ff79c6">..</span>data_size {
</span></span><span style="display:flex;"><span>    body[<span style="color:#bd93f9">4</span> <span style="color:#ff79c6">+</span> i] <span style="color:#ff79c6">=</span> real_key[i <span style="color:#ff79c6">&amp;</span> <span style="color:#bd93f9">3</span>] <span style="color:#ff79c6">^</span> body[<span style="color:#bd93f9">4</span> <span style="color:#ff79c6">+</span> i];
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>body <span style="color:#6272a4">// return the encrypted body
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="3-get_rf_payload">
  3. get_rf_payload
  <a class="heading-link" href="#3-get_rf_payload">
    <i class="fa-solid fa-link" aria-hidden="true" title="é“¾æ¥åˆ°æ ‡é¢˜"></i>
    <span class="sr-only">é“¾æ¥åˆ°æ ‡é¢˜</span>
  </a>
</h2>
<p>ä¸‡ä¸‡æƒ³ä¸åˆ°è¿™ä¸ªå‡½æ•°ç«Ÿç„¶æ˜¯æœ¬æœŸçš„ä¸»è§’ï¼Œå‡½æ•°ä¼ å…¥ <code>addr</code> åœ°å€, <code>addr_len</code> åœ°å€é•¿åº¦, <code>data</code> æ•°æ®, <code>data_len</code>
æ•°æ®é•¿åº¦ï¼Œæœ€ç»ˆå°†æ•°æ®å†™å¦‚ <code>result</code> è¿”å›ç»“æœã€‚</p>
<p>é¦–å…ˆæ˜ å…¥çœ¼å¸˜çš„æ˜¯ä¸¤ä¸ª <code>whitening_init</code> è°ƒç”¨ï¼Œçœ‹åå­—ä¼¼ä¹æ˜¯åœ¨åˆå§‹åŒ–ä»€ä¹ˆä¸œè¥¿ï¼Œç„¶åæ˜¯ä¸€ä¸ª <code>operator new[]</code>ï¼Œ
åœ¨è¿™é‡Œç”³è¯·äº† <code>0x12 + addr_len + data_len + 2</code> å¤§å°çš„å†…å­˜ã€‚</p>
<p>è¿™å—å†…å­˜æœ€ç»ˆè¢« copy åˆ°äº† <code>result</code> å†…ï¼Œåˆç†çŒœæµ‹è¿™å°±æ˜¯æ‰€éœ€çš„æœ€ç»ˆç»“æœã€‚</p>
<p>å‡½æ•°å†…éƒ¨çš„é€»è¾‘å¾ˆç®€å•ï¼Œçœ‹ç€åæ±‡ç¼–å°±èƒ½æŠŠå¤§æ¦‚é€»è¾‘æè¿°å‡ºæ¥ï¼š</p>
<ol>
<li>
<p>è¿™ä¸€æ®µæ˜¯å¯¹ç”³è¯·åçš„å†…å­˜è¿›è¡Œåˆå§‹åŒ–ï¼Œä¼¼ä¹åœ¨ <code>0x0f</code> å’Œ <code>0x10</code>, <code>0x11</code> è¿›è¡Œ hard-codedï¼š</p>
<p><img alt="rf-1" src="/posts/2023-04/reverse-the-fastcon-ble-protocol-2/rf_payload-1.png"></p>
</li>
<li>
<p>éšåæ˜¯ä¸€æ®µå¸¦æœ‰ SIMD ä¼˜åŒ–çš„å¾ªç¯ï¼Œæˆ‘ä»¬ä¸ç®¡ SIMD éƒ¨åˆ†ï¼Œç›´æ¥è·³åˆ° <code>label_1320c</code>ï¼š</p>
<p><img alt="rf-2" src="/posts/2023-04/reverse-the-fastcon-ble-protocol-2/rf_payload-2.png"></p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">label_1320c</span>:
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">int64_t</span> rest <span style="color:#ff79c6">=</span> (addr_len <span style="color:#ff79c6">-</span> copied_offset_1);
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">char</span><span style="color:#ff79c6">*</span> addrbuf_tmp <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>resultbuf[(copied_offset_1 <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">0x12</span>)];
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">int32_t</span> some_left <span style="color:#ff79c6">=</span> ((addr_len <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">1</span>) <span style="color:#ff79c6">-</span> x12_1);
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">do</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">char</span> c <span style="color:#ff79c6">=</span> addr_ptr[((<span style="color:#8be9fd">int64_t</span>)some_left)]; <span style="color:#6272a4">// c = addr[some_left]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    rest <span style="color:#ff79c6">=</span> (rest <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">1</span>);                       <span style="color:#6272a4">// rest--
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    some_left <span style="color:#ff79c6">=</span> (some_left <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">1</span>);             <span style="color:#6272a4">// some_left--
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">*</span>(<span style="color:#8be9fd">int8_t</span><span style="color:#ff79c6">*</span>)addrbuf_tmp <span style="color:#ff79c6">=</span> c;               <span style="color:#6272a4">// addrbuf_tmp[0] = c
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    addrbuf_tmp <span style="color:#ff79c6">=</span> ((<span style="color:#8be9fd">char</span><span style="color:#ff79c6">*</span>)addrbuf_tmp <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span>);  <span style="color:#6272a4">// addrbuf_tmp++
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>} <span style="color:#ff79c6">while</span> (rest <span style="color:#ff79c6">!=</span> <span style="color:#bd93f9">0</span>);
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸éš¾çœ‹å‡ºè¿™æ˜¯å¯¹ <code>addr</code> çš„é€†åºæ‹·è´ï¼Œ<code>copied_offset_1</code> å’Œ <code>x12_1</code> æ˜¯ç”¨äºè®°å½•åœ¨ SIMD
éƒ¨åˆ†å·²ç»æ‹·è´äº†å¤šå°‘å­—èŠ‚ï¼Œå› ä¸ºæ— éœ€å…³å¿ƒ SIMD éƒ¨åˆ†ï¼Œæ‰€ä»¥ç›´æ¥æŠŠä»–å½“ä½œ 0 å³å¯ã€‚</p>
<p>è¿™æ®µä»£ç æŠŠ <code>addr</code> å¤åˆ¶åˆ°äº† <code>resultbuf</code> çš„ <code>0x12</code> å¤„ã€‚</p>
</li>
<li>
<p>æ¥ä¸‹æ¥æ˜¯å¯¹ <code>data</code> çš„æ‹·è´ï¼Œä¸ä¸Šé¢ä¸ä¸€æ ·çš„æ˜¯ï¼Œè¿™æ¬¡çš„æ‹·è´æ˜¯æ­£å¸¸é¡ºåºçš„ï¼š</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">label_13274</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">char</span><span style="color:#ff79c6">*</span> data_dst <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>resultbuf[(x10_5 <span style="color:#ff79c6">+</span> (addr_len <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">0x12</span>))];
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">int64_t</span> x9_1 <span style="color:#ff79c6">=</span> (data_len_copy <span style="color:#ff79c6">-</span> x10_5);
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">char</span><span style="color:#ff79c6">*</span> data_src <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>data_ptr[x10_5];
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">int64_t</span> exit_cond;
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">do</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">char</span> c <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(<span style="color:#8be9fd">int8_t</span><span style="color:#ff79c6">*</span>)data_src;
</span></span><span style="display:flex;"><span>        data_src <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>datasrcptr[<span style="color:#bd93f9">1</span>];
</span></span><span style="display:flex;"><span>        exit_cond <span style="color:#ff79c6">=</span> x9_1;
</span></span><span style="display:flex;"><span>        x9_1 <span style="color:#ff79c6">=</span> (x9_1 <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">1</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">*</span>(<span style="color:#8be9fd">int8_t</span><span style="color:#ff79c6">*</span>)data_dst <span style="color:#ff79c6">=</span> c;
</span></span><span style="display:flex;"><span>        data_dst <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>data_dst[<span style="color:#bd93f9">1</span>];
</span></span><span style="display:flex;"><span>    } <span style="color:#ff79c6">while</span> (exit_cond <span style="color:#ff79c6">!=</span> <span style="color:#bd93f9">1</span>);
</span></span></code></pre></td></tr></table>
</div>
</div><p>åŒæ ·ï¼Œ<code>x10_5</code> å’Œ <code>data_len_copy</code> æ˜¯å¯ä»¥ç›´æ¥å½“ä½œ 0 çš„ã€‚</p>
<p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬çš„ <code>data_dst</code> æ˜¯ä» <code>resultbuf</code> çš„ <code>addr_len + 0x12</code> å¼€å§‹çš„ï¼Œè¿™æ˜¯å› ä¸º
è¦å°† <code>data</code> æ‹¼æ¥åœ¨ <code>addr</code> ä¹‹åã€‚</p>
</li>
<li>
<p>éšåæ˜¯ä¸€ä¸ªå¥‡æ€ªçš„å¾ªç¯ï¼š</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ff79c6">if</span> ((addr_len <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">3</span>) <span style="color:#ff79c6">&gt;=</span> <span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// count down from addr_len + 3
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">uint64_t</span> x27_1 <span style="color:#ff79c6">=</span> ((<span style="color:#8be9fd">uint64_t</span>)(addr_len <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">3</span>));
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">int8_t</span><span style="color:#ff79c6">*</span> x19_1 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>resultbuf[<span style="color:#bd93f9">0xf</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">uint64_t</span> temp0_1; <span style="color:#6272a4">// exit condition
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">do</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        temp0_1 <span style="color:#ff79c6">=</span> x27_1;
</span></span><span style="display:flex;"><span>        x27_1 <span style="color:#ff79c6">=</span> (x27_1 <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">1</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">*</span>x19_1 <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">invert_8</span>(<span style="color:#ff79c6">*</span>(<span style="color:#8be9fd">int8_t</span><span style="color:#ff79c6">*</span>)x19_1);
</span></span><span style="display:flex;"><span>        x19_1 <span style="color:#ff79c6">=</span> ((<span style="color:#8be9fd">char</span><span style="color:#ff79c6">*</span>)x19_1 <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span>);
</span></span><span style="display:flex;"><span>    } <span style="color:#ff79c6">while</span> (temp0_1 <span style="color:#ff79c6">!=</span> <span style="color:#bd93f9">1</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿˜è®°å¾—ä¹‹å‰ç¡¬ç¼–ç çš„ <code>0xf</code> å’Œ <code>0x10</code>, <code>0x11</code> ä½ç½®çš„æ•°æ®å—ï¼Œè¿™æ®µä»£ç å¯¹æ­¤å¤„ä» <code>0xf</code> å¼€å§‹çš„
<code>[3 + addr_len]</code> ä¸ªå­—èŠ‚è¿›è¡Œäº† &ldquo;invert&rdquo;ã€‚</p>
<p>è¯´åˆ°è¿™é‡Œï¼Œå°±ä¸å¾—ä¸æåˆ° <code>invert_8</code> è¿™ä¸ªå‡½æ•°ï¼š</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#50fa7b">uint64_t</span> invert_8(int32_t arg1)
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">int32_t</span> arg1  {Register x0}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">lsl</span>     w11, w0, <span style="color:#6272a4">#0x5           ; w11 = w0 &lt;&lt; 0x5
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#50fa7b">and</span>     w11, w11, <span style="color:#6272a4">#0x40         ; w11 = w11 &amp; 0x40
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#50fa7b">lsr</span>     w10, w0, <span style="color:#6272a4">#0x2           ; w10 = w0 &gt;&gt; 0x2
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#50fa7b">bfi</span>     w11, w0, <span style="color:#6272a4">#0x7, #0x19    ; w11 = w11 | (w0 &lt;&lt; 0x7)
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#50fa7b">lsr</span>     w9, w0, <span style="color:#6272a4">#0x3            ; w9 = w0 &gt;&gt; 0x3
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#50fa7b">bfi</span>     w11, w10, <span style="color:#6272a4">#0x5, #0x1    ; w11 = w11 | (w10 &lt;&lt; 0x5)
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#50fa7b">ubfx</span>    w10, w0, <span style="color:#6272a4">#0x1, #0x7     ; w10 = w0 &amp; 0x7f
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#50fa7b">bfi</span>     w11, w9, <span style="color:#6272a4">#0x4, #0x1     ; w11 = w11 | (w9 &lt;&lt; 0x4)
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#50fa7b">ubfx</span>    w9, w0, <span style="color:#6272a4">#0x3, #0x5      ; w9 = w0 &amp; 0x1f
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#50fa7b">and</span>     w10, w10, <span style="color:#6272a4">#0x8          ; w10 = w10 &amp; 0x8
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#50fa7b">ubfx</span>    w12, w0, <span style="color:#6272a4">#0x5, #0x3     ; w12 = w0 &amp; 0x7
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#50fa7b">and</span>     w9, w9, <span style="color:#6272a4">#0x4            ; w9 = w9 &amp; 0x4
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#50fa7b">orr</span>     w10, w11, w10           <span style="color:#6272a4">; w10 = w11 | w10
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#50fa7b">orr</span>     w9, w10, w9             <span style="color:#6272a4">; w9 = w10 | w9
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#50fa7b">and</span>     w10, w12, <span style="color:#6272a4">#0x2          ; w10 = w12 &amp; 0x2
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#50fa7b">and</span>     w8, w0, <span style="color:#6272a4">#0xff           ; w8 = w0 &amp; 0xff
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#50fa7b">orr</span>     w9, w9, w10             <span style="color:#6272a4">; w9 = w9 | w10
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#50fa7b">orr</span>     w0, w9, w8, lsr <span style="color:#6272a4">#0x7    ; w0 = w9 | (w8 &gt;&gt; 0x7)
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#50fa7b">ret</span>                             <span style="color:#6272a4">; return w0
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™ä¸ªå‡½æ•°æ˜æ˜åšçš„æ˜¯ <code>reverse</code>ï¼Œä½†æ˜¯å´å« <code>invert</code>ï¼Œå¯æƒ³è€ŒçŸ¥è¿™ä½å¼€å‘è€…å¯èƒ½åœ¨å†™çš„æ—¶å€™èµ°ç¥äº†ï¼š</p>
<ul>
<li><code>invert(0b00111111) = 0b11000000</code></li>
<li><code>reverse(0b00111111) = 0b11111000</code></li>
</ul>
<p>è¿™ä¸ª <code>invert_8</code> å‡½æ•°ä¸‹é¢è¿˜æœ‰ä¸€ä¸ª <code>invert_16</code>ï¼Œäºæ˜¯ç›´æ¥å½“ä½œ <code>reverse</code> äº†ã€‚</p>
</li>
<li>
<p>åœ¨ reverse ä¸€éƒ¨åˆ† bytes åï¼Œè¿™ä¸ªå‡½æ•°åˆè®¡ç®—äº† <code>addr</code> å’Œ <code>data</code> çš„ CRC-16ï¼Œå°†å¾—åˆ°çš„ 16 ä½
CRC æ‹¼æ¥åœ¨äº†æœ€åï¼ˆè¿™å°±æ˜¯ä¸ºä»€ä¹ˆä¸€å¼€å§‹ç”³è¯·å†…å­˜çš„æ—¶å€™è¦åŠ  2 äº†ï¼‰ï¼š</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ff79c6">const</span> <span style="color:#8be9fd">int32_t</span> crc_start <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0x12</span> <span style="color:#ff79c6">+</span> addr_len <span style="color:#ff79c6">+</span> data_len;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">const</span> <span style="color:#8be9fd">int16_t</span> crc <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">check_crc16</span>(addr_ptr, addr_len, data_ptr, data_len);
</span></span><span style="display:flex;"><span>resultbuf[crc_start] <span style="color:#ff79c6">=</span> x0_5;          <span style="color:#6272a4">// crc low byte
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>resultbuf[crc_start <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span>] <span style="color:#ff79c6">=</span> x0_5 <span style="color:#ff79c6">&gt;&gt;</span> <span style="color:#bd93f9">8</span>; <span style="color:#6272a4">// crc high byte
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™ä¸ª CRC å‡½æ•°ååˆ† susï¼šä»–æ¥å—ä¸¤ä¸ª bufferï¼Œæ‰€ä»¥æˆ‘ä¸¥é‡æ€€ç–‘æ˜¯ä»€ä¹ˆè‡ªå·±çš„è½®å­ï¼š</p>
<p><img alt="rf_payload-crc1" src="/posts/2023-04/reverse-the-fastcon-ble-protocol-2/rf_payload-crc1.png"></p>
<p>è¿™æ˜¯ä¸€å¨ä»€ä¹ˆå¤§ä¾¿ï¼Œæˆ‘ä¸æƒ³çœ‹äº†ã€‚</p>
<p>ç»è¿‡åƒè¾›ä¸‡è‹¦åœ°åŒ–ç®€ï¼Œæˆ‘ç»ˆäºæŠŠè¿™ä¸ªå‡½æ•°åŒ–ç®€æˆäº†è¿™æ ·ï¼š</p>
<p><img alt="crc16" src="/posts/2023-04/reverse-the-fastcon-ble-protocol-2/crc16.png"></p>
</li>
<li>
<p>whitening_init</p>
<blockquote>
<p>ä¿¡å·çš„ç™½åŒ–æ˜¯ä¸€ç§å¸¸è§çš„ä¿¡å·å¤„ç†æŠ€æœ¯ï¼Œå®ƒçš„ç›®çš„æ˜¯å°†ä¿¡å·çš„é¢‘è°±åˆ†å¸ƒå‡åŒ€åŒ–ï¼Œä½¿å¾—ä¿¡å·çš„é¢‘è°±
æ›´åŠ å¹³æ»‘ï¼Œä»è€Œä½¿å¾—ä¿¡å·æ›´åŠ ç¨³å®šã€‚
&mdash; GitHub Copilot</p>
</blockquote>
<p>è¿™æ®µä»£ç ï¼ˆä¸Šæ–‡æåˆ°è¿‡ï¼‰æ¶‰åŠåˆ°äº†ä¸¤æ¬¡ <code>whitening_init</code> è°ƒç”¨å’Œä¸€æ¬¡ <code>whitening_encode</code>ï¼š</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8be9fd">whitening_ctx_t</span> var_88; <span style="color:#6272a4">// æ„Ÿè§‰åƒæ˜¯ä¸€ä¸ª structï¼Œä½†æ˜¯è¢«ä¼˜åŒ–æ‰äº†
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#8be9fd">whitening_ctx_t</span> var_a8;
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">whitening_init</span>(<span style="color:#bd93f9">0x25</span>, <span style="color:#ff79c6">&amp;</span>var_88);
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">whitening_init</span>(<span style="color:#bd93f9">0x3f</span>, <span style="color:#ff79c6">&amp;</span>var_a8);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// åœ¨è®¡ç®—å¥½ CRC ä¹‹å
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#50fa7b">whitenging_encode</span>(resultbuf, (result_data_size <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">2</span>), <span style="color:#ff79c6">&amp;</span>var_88);
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¾ˆæœ‰æ„æ€çš„æ˜¯ï¼Œ<code>var_a8</code> ä»æ¥æ²¡æœ‰ä½¿ç”¨è¿‡ï¼Œè¿™ä¸ªå˜é‡æ˜¯ä¸æ˜¯å¤šä½™çš„å‘¢ï¼Ÿ</p>
<p>è¿™å°±è¦å»çœ‹çœ‹ <code>whitening_init</code> æœ‰æ²¡æœ‰å‰¯ä½œç”¨äº†ï¼š</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#6272a4">; whitening_ctx_t æ˜¯ç›®å‰è¿˜ä¸çŸ¥é“çš„ä¸€ä¸ª struct
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">; void whitening_init(int64_t arg1, whitening_ctx_t* arg2)
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">; int64_t arg1           {Register x0}
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">; whitening_ctx_t* arg2  {Register x1}
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">; è¿™ä¸¤è¡ŒæŠŠ data_31ac0 åŠ è½½åˆ° q0
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">; åœ¨ ARM ä¸­ï¼Œq0 å¯„å­˜å™¨æ˜¯ä¸€ä¸ª 128 ä½çš„å¯„å­˜å™¨ï¼Œç”¨äºåœ¨ SIMD æŒ‡ä»¤ä¸­å­˜å‚¨æ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">; æˆ‘ä»¬è¿™é‡Œçš„ data_31ac0 å…¶å®å°±æ˜¯ [5, 4, 3, 2] å››ä¸ª 32 ä½çš„æ•´æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#50fa7b">adrp</span>    x8, <span style="color:#bd93f9">0x31000</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">ldr</span>     q0, [x8, <span style="color:#6272a4">#0xac0]  {data_31ac0}
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">dup</span>     v1.4s, w0            <span style="color:#6272a4">; v1 = [arg1, arg1, arg1, arg1]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#50fa7b">orr</span>     w8, wzr, <span style="color:#6272a4">#0x1        ; w8 = 0x1
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">str</span>     w8, [x1]  {<span style="color:#bd93f9">0x1</span>}      <span style="color:#6272a4">; å°† w8 å­˜å…¥ x1 æŒ‡å‘çš„å†…å­˜ï¼ˆ0x1 æ˜¯ä»€ä¹ˆæˆ‘ä¸çŸ¥é“ï¼‰
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#50fa7b">neg</span>     v0.4s, v0.4s         <span style="color:#6272a4">; v0 = ~v0
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#50fa7b">ushl</span>    v0.4s, v1.4s, v0.4s  <span style="color:#6272a4">; v0 = v0 &lt;&lt; v1
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#50fa7b">movi</span>    v1.4s, <span style="color:#6272a4">#0x1          ; v1 = [1, 1, 1, 1]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">ubfx</span>    w8, w0, <span style="color:#6272a4">#0x1, #0x1       ; w8 = (w0 &gt;&gt; 0x1) &amp; 0x1
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#50fa7b">and</span>     w9, w0, <span style="color:#6272a4">#0x1             ; w9 = w0 &amp; 0x1
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#50fa7b">and</span>     v0.16b, v0.16b, v1.16b   <span style="color:#6272a4">; v0 = v0 &amp; v1 æŒ‰ä½ä¸
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">stur</span>    q0, [x1, <span style="color:#6272a4">#0x4]       ; [x1, #0x4] = v0
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#50fa7b">stp</span>     w8, w9, [x1, <span style="color:#6272a4">#0x14]  ; [x1] = w8, [x1, #0x8] = w9
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">; æ‹œæ‹œï½ï½ï½
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#50fa7b">ret</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªå…ˆå–åå†å·¦ç§»çš„æ“ä½œï¼Œåœ¨å®é™…æƒ…å†µä¸­å…¶å®å°±æ˜¯å³ç§»â€¦â€¦æˆ‘è¢«è¿™ä¸ªé—®é¢˜å›°æ‰°äº†å¾ˆä¹…ã€‚
æœ€ç»ˆç”šè‡³è¿˜åœ¨ Android ä¸ŠæŒ‚äº† lldb è°ƒè¯•ï¼Œæ‰å‘ç°äº†è¿™ä¸ªé—®é¢˜ï¼š</p>
<p><img alt="whitening-1" src="/posts/2023-04/reverse-the-fastcon-ble-protocol-2/whitening-1.png"></p>
<p>æ¥ä¸‹æ¥çš„æ­¥éª¤å°±æ˜¯å°†å…¶ç¿»è¯‘ä¸º Rustï¼š</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#ff79c6">#[derive(Debug, Clone, Copy, Default)]</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">pub</span>(<span style="color:#ff79c6">crate</span>) <span style="color:#ff79c6">struct</span> <span style="color:#50fa7b">WhiteningContext</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// æˆ‘å®Œå…¨ä¸çŸ¥é“è¿™äº›å­—æ®µæ˜¯ä»€ä¹ˆæ„æ€ï¼Œæ‰€ä»¥ç›´æ¥ç”¨åç§»é‡ä½œä¸ºå­—æ®µåäº†
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    f_0x0: <span style="color:#8be9fd">u32</span>,
</span></span><span style="display:flex;"><span>    f_0x4: <span style="color:#8be9fd">u32</span>,
</span></span><span style="display:flex;"><span>    f_0x8: <span style="color:#8be9fd">u32</span>,
</span></span><span style="display:flex;"><span>    f_0xc: <span style="color:#8be9fd">u32</span>,
</span></span><span style="display:flex;"><span>    f_0x10: <span style="color:#8be9fd">u32</span>,
</span></span><span style="display:flex;"><span>    f_0x14: <span style="color:#8be9fd">u32</span>,
</span></span><span style="display:flex;"><span>    f_0x18: <span style="color:#8be9fd">u32</span>,
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">pub</span>(<span style="color:#ff79c6">crate</span>) <span style="color:#ff79c6">fn</span> <span style="color:#50fa7b">whitening_init</span>(val: <span style="color:#8be9fd">u32</span>, ctx: <span style="color:#ff79c6">&amp;</span><span style="color:#50fa7b">mut</span> WhiteningContext) {
</span></span><span style="display:flex;"><span>     <span style="color:#8be9fd;font-style:italic">let</span> v0 <span style="color:#ff79c6">=</span> [(val <span style="color:#ff79c6">&gt;&gt;</span> <span style="color:#bd93f9">5</span>), (val <span style="color:#ff79c6">&gt;&gt;</span> <span style="color:#bd93f9">4</span>), (val <span style="color:#ff79c6">&gt;&gt;</span> <span style="color:#bd93f9">3</span>), (val <span style="color:#ff79c6">&gt;&gt;</span> <span style="color:#bd93f9">2</span>)];
</span></span><span style="display:flex;"><span>     ctx.f_0x0 <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
</span></span><span style="display:flex;"><span>     ctx.f_0x4 <span style="color:#ff79c6">=</span> v0[<span style="color:#bd93f9">0</span>] <span style="color:#ff79c6">&amp;</span> <span style="color:#bd93f9">1</span>;
</span></span><span style="display:flex;"><span>     ctx.f_0x8 <span style="color:#ff79c6">=</span> v0[<span style="color:#bd93f9">1</span>] <span style="color:#ff79c6">&amp;</span> <span style="color:#bd93f9">1</span>;
</span></span><span style="display:flex;"><span>     ctx.f_0xc <span style="color:#ff79c6">=</span> v0[<span style="color:#bd93f9">2</span>] <span style="color:#ff79c6">&amp;</span> <span style="color:#bd93f9">1</span>;
</span></span><span style="display:flex;"><span>     ctx.f_0x10 <span style="color:#ff79c6">=</span> v0[<span style="color:#bd93f9">3</span>] <span style="color:#ff79c6">&amp;</span> <span style="color:#bd93f9">1</span>;
</span></span><span style="display:flex;"><span>     ctx.f_0x14 <span style="color:#ff79c6">=</span> (val <span style="color:#ff79c6">&gt;&gt;</span> <span style="color:#bd93f9">1</span>) <span style="color:#ff79c6">&amp;</span> <span style="color:#bd93f9">1</span>;
</span></span><span style="display:flex;"><span>     ctx.f_0x18 <span style="color:#ff79c6">=</span> val <span style="color:#ff79c6">&amp;</span> <span style="color:#bd93f9">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>whitening_encode</p>
<ul>
<li>å¥½æ¶ˆæ¯ï¼šè¿™æ˜¯æˆ‘ä»¬æœ€åä¸€ä¸ªå‡½æ•°äº†ï¼</li>
<li>å¥½æ¶ˆæ¯ï¼šè¿™ä¸ªå‡½æ•°é€»è¾‘éå¸¸ç®€å•ï¼Œæ²¡æœ‰ SIMDï¼Œæ²¡æœ‰æ€ªå¼‚çš„ä½è¿ç®—</li>
<li>å¥½æ¶ˆæ¯ï¼šè¿™ä¸ªå‡½æ•°é‡Œé¢å°±ä¸€ä¸ªå¾ªç¯ï¼Œæ¯æ¬¡å¾ªç¯æ›´æ–° data å†…çš„ä¸€ä¸ªå­—èŠ‚ï¼Œå¹¶ä¸”æ›´æ–° ctx</li>
<li>å¥½æ¶ˆæ¯ï¼šç›´æ¥ä» Binary Ninja ä¸­å¤åˆ¶å‡ºä»£ç è¿›è¡Œç¿»è¯‘å³å¯</li>
</ul>
<p>ç”šè‡³æ²¡æœ‰ä»€ä¹ˆå€¼å¾—è¯´çš„ï¼š</p>
<p><img alt="whitening-2" src="/posts/2023-04/reverse-the-fastcon-ble-protocol-2/whitening-2.png"></p>
</li>
</ol>
<p>è‡³æ­¤ï¼Œæˆ‘å°±å®Œæˆäº†æ‰€éœ€ native å‡½æ•°çš„é€†å‘ï¼Œæ¥ä¸‹æ¥å°±æ˜¯å°†å…¶æ•´åˆå¹¶é‡æ„æˆä¸€ä¸ªçœ‹èµ·æ¥èˆ’æœçš„ Rust åº“äº†ã€‚</p>
<p>åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å¤§æ¦‚ä¼šä»‹ç» Fastcon çš„å¤§è‡´é€»è¾‘ã€‚</p>
<p>æ‰€ä»¥ï¼Œæ™šå®‰ï½</p>

      </div>


      <footer>
        


        
        
        <div class="comments">
  <script>

    let getTheme = window.localStorage && window.localStorage.getItem("colorscheme");
    let themeInParams = '';

    if (getTheme == null) {
      if (themeInParams !== '' && themeInParams !== 'auto') {
        getTheme = themeInParams;
      }
      else {
        getTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? "dark" : "light";
      }
    }

    let theme = getTheme === 'dark' ? 'github-dark' : 'github-light';
    let s = document.createElement('script');
    s.src = 'https://utteranc.es/client.js';
    s.setAttribute('repo', 'moodyhunter\/moodyhunter.github.io');
    s.setAttribute('issue-term', 'pathname');
    s.setAttribute('theme', theme);
    s.setAttribute('crossorigin', 'anonymous');
    s.setAttribute('async', '');
    document.querySelector('div.comments').innerHTML = '';
    document.querySelector('div.comments').appendChild(s);

  </script>
</div>
        
        

        
      </footer>
    </article>

    
  </section>

    </div>

    <footer class="footer">
  <section class="container">
    Â©
    
      2021 -
    
    2024
     Moody 
    Â·
    
      è®¸å¯ä¾æ® <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA-4.0</a>
    Â·
    
    æŠ€æœ¯æ”¯æŒ <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/" target="_blank" rel="noopener">Coder</a>.
    
  </section>
</footer>

  </main>

  

  
  
  <script src="/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js" integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script>
  

  

  


  

  

  

  

  

  

  

  

  

  <script type="text/javascript">
    !function(T,l,y){var S=T.location,k="script",D="connectionString",C="ingestionendpoint",I="disableExceptionTracking",E="ai.device.",b="toLowerCase",w="crossOrigin",N="POST",e="appInsightsSDK",t=y.name||"appInsights";(y.name||T[e])&&(T[e]=t);var n=T[t]||function(d){var g=!1,f=!1,m={initialize:!0,queue:[],sv:"5",version:2,config:d};function v(e,t){var n={},a="Browser";return n[E+"id"]=a[b](),n[E+"type"]=a,n["ai.operation.name"]=S&&S.pathname||"_unknown_",n["ai.internal.sdkVersion"]="javascript:snippet_"+(m.sv||m.version),{time:function(){var e=new Date;function t(e){var t=""+e;return 1===t.length&&(t="0"+t),t}return e.getUTCFullYear()+"-"+t(1+e.getUTCMonth())+"-"+t(e.getUTCDate())+"T"+t(e.getUTCHours())+":"+t(e.getUTCMinutes())+":"+t(e.getUTCSeconds())+"."+((e.getUTCMilliseconds()/1e3).toFixed(3)+"").slice(2,5)+"Z"}(),name:"Microsoft.ApplicationInsights."+e.replace(/-/g,"")+"."+t,sampleRate:100,tags:n,data:{baseData:{ver:2}}}}var h=d.url||y.src;if(h){function a(e){var t,n,a,i,r,o,s,c,u,p,l;g=!0,m.queue=[],f||(f=!0,t=h,s=function(){var e={},t=d.connectionString;if(t)for(var n=t.split(";"),a=0;a<n.length;a++){var i=n[a].split("=");2===i.length&&(e[i[0][b]()]=i[1])}if(!e[C]){var r=e.endpointsuffix,o=r?e.location:null;e[C]="https://"+(o?o+".":"")+"dc."+(r||"services.visualstudio.com")}return e}(),c=s[D]||d[D]||"",u=s[C],p=u?u+"/v2/track":d.endpointUrl,(l=[]).push((n="SDK LOAD Failure: Failed to load Application Insights SDK script (See stack for details)",a=t,i=p,(o=(r=v(c,"Exception")).data).baseType="ExceptionData",o.baseData.exceptions=[{typeName:"SDKLoadFailed",message:n.replace(/\./g,"-"),hasFullStack:!1,stack:n+"\nSnippet failed to load ["+a+"] -- Telemetry is disabled\nHelp Link: https://go.microsoft.com/fwlink/?linkid=2128109\nHost: "+(S&&S.pathname||"_unknown_")+"\nEndpoint: "+i,parsedStack:[]}],r)),l.push(function(e,t,n,a){var i=v(c,"Message"),r=i.data;r.baseType="MessageData";var o=r.baseData;return o.message='AI (Internal): 99 message:"'+("SDK LOAD Failure: Failed to load Application Insights SDK script (See stack for details) ("+n+")").replace(/\"/g,"")+'"',o.properties={endpoint:a},i}(0,0,t,p)),function(e,t){if(JSON){var n=T.fetch;if(n&&!y.useXhr)n(t,{method:N,body:JSON.stringify(e),mode:"cors"});else if(XMLHttpRequest){var a=new XMLHttpRequest;a.open(N,t),a.setRequestHeader("Content-type","application/json"),a.send(JSON.stringify(e))}}}(l,p))}function i(e,t){f||setTimeout(function(){!t&&m.core||a()},500)}var e=function(){var n=l.createElement(k);n.src=h;var e=y[w];return!e&&""!==e||"undefined"==n[w]||(n[w]=e),n.onload=i,n.onerror=a,n.onreadystatechange=function(e,t){"loaded"!==n.readyState&&"complete"!==n.readyState||i(0,t)},n}();y.ld<0?l.getElementsByTagName("head")[0].appendChild(e):setTimeout(function(){l.getElementsByTagName(k)[0].parentNode.appendChild(e)},y.ld||0)}try{m.cookie=l.cookie}catch(p){}function t(e){for(;e.length;)!function(t){m[t]=function(){var e=arguments;g||m.queue.push(function(){m[t].apply(m,e)})}}(e.pop())}var n="track",r="TrackPage",o="TrackEvent";t([n+"Event",n+"PageView",n+"Exception",n+"Trace",n+"DependencyData",n+"Metric",n+"PageViewPerformance","start"+r,"stop"+r,"start"+o,"stop"+o,"addTelemetryInitializer","setAuthenticatedUserContext","clearAuthenticatedUserContext","flush"]),m.SeverityLevel={Verbose:0,Information:1,Warning:2,Error:3,Critical:4};var s=(d.extensionConfig||{}).ApplicationInsightsAnalytics||{};if(!0!==d[I]&&!0!==s[I]){var c="onerror";t(["_"+c]);var u=T[c];T[c]=function(e,t,n,a,i){var r=u&&u(e,t,n,a,i);return!0!==r&&m["_"+c]({message:e,url:t,lineNumber:n,columnNumber:a,error:i}),r},d.autoExceptionInstrumented=!0}return m}(y.cfg);function a(){y.onInit&&y.onInit(n)}(T[t]=n).queue&&0===n.queue.length?(n.queue.push(a),n.trackPageView({})):a()}(window,document,{
    src: "https://js.monitor.azure.com/scripts/b/ai.2.min.js", 
    
    
    
    crossOrigin: "anonymous", 
    
    cfg: { 
        connectionString: "InstrumentationKey=5a5bbde5-faba-4982-8376-789e51b32d12;IngestionEndpoint=https:\/\/uksouth-1.in.applicationinsights.azure.com\/;LiveEndpoint=https:\/\/uksouth.livediagnostics.monitor.azure.com\/"
         
    }});
    </script>    


  

  

  

  

  

  
</body>

</html>
