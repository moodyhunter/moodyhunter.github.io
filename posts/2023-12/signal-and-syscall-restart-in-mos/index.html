<!DOCTYPE html>
<html lang="zh-cn">

<head>
  <title>
  Signals, and automatic restart of signal-interrupted syscalls · Moody&#39;s
</title>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="light dark">


<meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests; block-all-mixed-content; default-src 'self'; child-src 'self'; font-src 'self' https://fonts.gstatic.com https://cdn.jsdelivr.net; form-action 'self' https://utteranc.es; frame-src 'self' https://utteranc.es; img-src 'self' https:; object-src 'none'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.jsdelivr.net https://utteranc.es; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://utteranc.es https://static.cloudflareinsights.com https://js.monitor.azure.com; connect-src 'self' https://utteranc.es https://uksouth-1.in.applicationinsights.azure.com;">




<meta name="author" content="Moody">
<meta name="description" content="This post is about your sleep quality, or not yours, but your program&rsquo;s.
Thoughout this post, implementation details of MOS are used as examples, but the concepts should be applicable to other OS kernels (e.g. Linux).
Signals When are Signals Delivered? How Long Can a System Call Last? What Wakes You Up? Signals Ruin Everything Where are we returning to? Can we do better? SA_RESTART and siginterrupt(3p) What does the kernel need to know, to restart the syscall?">
<meta name="keywords" content="blog,personal,中文,个人">

<meta name="twitter:card" content="summary"/><meta name="twitter:title" content="Signals, and automatic restart of signal-interrupted syscalls"/>
<meta name="twitter:description" content="This post is about your sleep quality, or not yours, but your program&rsquo;s.
Thoughout this post, implementation details of MOS are used as examples, but the concepts should be applicable to other OS kernels (e.g. Linux).
Signals When are Signals Delivered? How Long Can a System Call Last? What Wakes You Up? Signals Ruin Everything Where are we returning to? Can we do better? SA_RESTART and siginterrupt(3p) What does the kernel need to know, to restart the syscall?"/>

<meta property="og:title" content="Signals, and automatic restart of signal-interrupted syscalls" />
<meta property="og:description" content="This post is about your sleep quality, or not yours, but your program&rsquo;s.
Thoughout this post, implementation details of MOS are used as examples, but the concepts should be applicable to other OS kernels (e.g. Linux).
Signals When are Signals Delivered? How Long Can a System Call Last? What Wakes You Up? Signals Ruin Everything Where are we returning to? Can we do better? SA_RESTART and siginterrupt(3p) What does the kernel need to know, to restart the syscall?" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://mooody.me/posts/2023-12/signal-and-syscall-restart-in-mos/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-09T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-12-09T00:00:00+00:00" />




<link rel="canonical" href="https://mooody.me/posts/2023-12/signal-and-syscall-restart-in-mos/">


<link rel="preload" href="/fonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/fonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/fonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin>


  
  
  <link rel="stylesheet" href="/css/coder.min.38c4552ac40f9ae3408bad40358f654ebd8804412fe74ed56f2d6c8a7af82dd3.css" integrity="sha256-OMRVKsQPmuNAi61ANY9lTr2IBEEv507Vby1sinr4LdM=" crossorigin="anonymous" media="screen" />






  
    
    
    <link rel="stylesheet" href="/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css" integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin="anonymous" media="screen" />
  



 


  
  
    
    <link rel="stylesheet" href="/scss/cards.min.66689eb6794f4d37bf49748d47a91d8dc5918d78d800a8fae4f1a9649ce35145.css" integrity="sha256-ZmietnlPTTe/SXSNR6kdjcWRjXjYAKj65PGpZJzjUUU=" crossorigin="anonymous" media="screen" />
  

  
  
    
    <link rel="stylesheet" href="/scss/spoiler.min.6758d9b6919e25bb0a3c105fb53c53d4329838c7c3c6c41a4443a232bcca0886.css" integrity="sha256-Z1jZtpGeJbsKPBBftTxT1DKYOMfDxsQaREOiMrzKCIY=" crossorigin="anonymous" media="screen" />
  



<link rel="icon" type="image/svg+xml" href="/images/favicon.svg" sizes="any">
<link rel="icon" type="image/png" href="/images/favicon.ico" sizes="32x32">
<link rel="icon" type="image/png" href="/images/favicon.ico" sizes="16x16">

<link rel="apple-touch-icon" href="/images/favicon.ico">
<link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.ico">

<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#5bbad5">






<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css"
/>
<script
  defer
  src="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.js"
></script>
<script
  defer
  src="https://cdn.jsdelivr.net/npm/katex@latest/dist/contrib/auto-render.min.js"
  onload="renderMathInElement(document.body);"
></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    renderMathInElement(document.body, {
      delimiters: [
        { left: "$$", right: "$$", display: true },
        { left: "$", right: "$", display: false },
      ],
    });
  });
</script>



</head>






<body class="preload-transitions colorscheme-auto">
  
<div class="float-container">
    <a id="dark-mode-toggle" class="colorscheme-toggle">
        <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
    </a>
</div>


  <main class="wrapper">
    <nav class="navigation">
  <section class="container">
    
    <a class="navigation-title" href="https://mooody.me/">
      Moody&#39;s
    </a>
    
    
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa-solid fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link " href="/">主页</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="/posts/">文章</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="/friends/">友链</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="/about/">我</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="https://g.mooody.me/public-dashboards/305e9305e46240eb80345e055738c236?orgId=1&amp;theme=light&amp;refresh=10s">服务状态</a>
            </li>
          
        
        
          
          
          
            
          
            
              
                <li class="navigation-item menu-separator">
                  <span>|</span>
                </li>
                
              
              <li class="navigation-item">
                <a href="/en/">🇬🇧</a>
              </li>
            
          
        
      </ul>
    
  </section>
</nav>


    <div class="content">
      
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">
            <a class="title-link" href="https://mooody.me/posts/2023-12/signal-and-syscall-restart-in-mos/">
              Signals, and automatic restart of signal-interrupted syscalls
            </a>
          </h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fa-solid fa-calendar" aria-hidden="true"></i>
              <time datetime="2023-12-09T00:00:00Z">
                December 9, 2023
              </time>
            </span>
            <span class="reading-time">
              <i class="fa-solid fa-clock" aria-hidden="true"></i>
              阅读时间：12 分钟
            </span>
          </div>
          
          
          <div class="tags">
  <i class="fa-solid fa-tag" aria-hidden="true"></i>
    <span class="tag">
      <a href="/tags/mos/">MOS</a>
    </span>
      <span class="separator">•</span>
    <span class="tag">
      <a href="/tags/os/">OS</a>
    </span>
      <span class="separator">•</span>
    <span class="tag">
      <a href="/tags/operating-system/">Operating System</a>
    </span>
      <span class="separator">•</span>
    <span class="tag">
      <a href="/tags/syscall/">Syscall</a>
    </span>
      <span class="separator">•</span>
    <span class="tag">
      <a href="/tags/signal/">Signal</a>
    </span></div>

        </div>
      </header>

      <div class="post-content">
        
        <p>This post is about your sleep quality, or not yours, but your program&rsquo;s.</p>
<p>Thoughout this post, implementation details of MOS are used as examples, but
the concepts should be applicable to other OS kernels (e.g. Linux).</p>
<ul>
<li><a href="#signals" >Signals</a>
<ul>
<li><a href="#when-are-signals-delivered" >When are Signals Delivered?</a></li>
<li><a href="#how-long-can-a-system-call-last" >How Long Can a System Call Last?</a>
<ul>
<li><a href="#what-wakes-you-up" >What Wakes You Up?</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#signals-ruin-everything" >Signals Ruin Everything</a>
<ul>
<li><a href="#where-are-we-returning-to" >Where are we returning to?</a></li>
</ul>
</li>
<li><a href="#can-we-do-better" >Can we do better?</a>
<ul>
<li><a href="#sa_restart-and-siginterrupt3p" >SA_RESTART and siginterrupt(3p)</a></li>
<li><a href="#what-does-the-kernel-need-to-know-to-restart-the-syscall" >What does the kernel need to know, to restart the syscall?</a></li>
<li><a href="#-erestartsys-comes-to-the-rescue" >-ERESTARTSYS Comes to the Rescue</a></li>
<li><a href="#how-this-works" >How This Works?</a></li>
<li><a href="#why-mangling-the-instruction-pointer" >Why mangling the instruction pointer?</a></li>
<li><a href="#concerns-and-limitations" >Concerns and Limitations</a></li>
</ul>
</li>
<li><a href="#conclusion" >Conclusion</a></li>
<li><a href="#references" >References</a></li>
</ul>
<p>It is always said&hellip;</p>
<blockquote>
<p>Upon a signal being delivered to a process, the kernel <u><strong>interrupts</strong></u> the
process and <u><strong>invokes</strong></u> the signal handler. If the handler returns, the
kernel <u><strong>resumes</strong></u> the process from <u><strong>the instruction where it was interrupted</strong></u>.</p>
</blockquote>
<p>&hellip;but how?</p>
<h2 id="signals">
  Signals
  <a class="heading-link" href="#signals">
    <i class="fa-solid fa-link" aria-hidden="true" title="链接到标题"></i>
    <span class="sr-only">链接到标题</span>
  </a>
</h2>
<p>A signal is like a notification sent to a process to inform it that something
<del>interesting</del> has occurred:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ff79c6">#define SIGFPE 8    </span><span style="color:#6272a4">// floating point exception
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">#define SIGILL 4    </span><span style="color:#6272a4">// illegal instruction
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">#define SIGINT 2    </span><span style="color:#6272a4">// interrupt
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">#define SIGSEGV 11  </span><span style="color:#6272a4">// segmentation fault
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">#define SIGTERM 15  </span><span style="color:#6272a4">// polite request to terminate
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Applications can decide either to ignore signals or to handle them by installing
signal handlers using <code>sigaction()</code>, or an outdated API, <code>signal()</code>.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8be9fd">int</span> <span style="color:#50fa7b">sigaction</span>(<span style="color:#8be9fd">int</span> sig, <span style="color:#ff79c6">const</span> <span style="color:#ff79c6">struct</span> sigaction <span style="color:#ff79c6">*</span>newact, <span style="color:#ff79c6">struct</span> sigaction <span style="color:#ff79c6">*</span>oldact);
</span></span><span style="display:flex;"><span>__attribute_deprecated__ <span style="color:#8be9fd">sighandler_t</span> <span style="color:#50fa7b">signal</span>(<span style="color:#8be9fd">int</span> sig, <span style="color:#8be9fd">sighandler_t</span> handler);
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="when-are-signals-delivered">
  When are Signals Delivered?
  <a class="heading-link" href="#when-are-signals-delivered">
    <i class="fa-solid fa-link" aria-hidden="true" title="链接到标题"></i>
    <span class="sr-only">链接到标题</span>
  </a>
</h3>
<p>According to the POSIX standard:</p>
<blockquote>
<h4>Execution of signal handlers:</h4>
<p>Whenever there is a transition from <u><strong>kernel-mode to user-mode</strong></u>
execution, e.g., on:</p>
<ul>
<li>return from a system call, or</li>
<li>scheduling of a thread onto the CPU.</li>
</ul>
<p>The kernel checks whether there is a
pending unblocked signal for which the process has established a
signal handler. If there is such a pending signal, the following
steps occur&hellip;</p>
</blockquote>
<p>Delivering signals is straightforward when it&rsquo;s the case of
the second bullet point, as shown in the code below:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8be9fd">void</span> <span style="color:#50fa7b">return_to_userspace</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> (has_pending_signal) {
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">save_context</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">setup_signal_frame</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">jump_to_signal_handler</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">unreachable</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">do_return_to_userspace</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">unreachable</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>more about <a href="https://en.cppreference.com/w/c/program/unreachable"  class="external-link" target="_blank" rel="noopener">unreachable()</a>.</p>
<p>How about the first one?</p>
<p>The first bullet point effectively implies that a signal must occur <strong>after</strong>
a system call returns.</p>
<ul>
<li>What if that system call lasts a long time?</li>
<li>What if, for the worst case, the system call just never returns?</li>
</ul>
<p>In those cases, how can the kernel deliver signals in time? Before moving on,
let&rsquo;s focus on how a system call is executed, and how long it can last.</p>
<h3 id="how-long-can-a-system-call-last">
  How Long Can a System Call Last?
  <a class="heading-link" href="#how-long-can-a-system-call-last">
    <i class="fa-solid fa-link" aria-hidden="true" title="链接到标题"></i>
    <span class="sr-only">链接到标题</span>
  </a>
</h3>
<p>A system call can last for a long time, for example, <code>read()</code> can last
forever if the file is never written to (imagine a named pipe), or the
user never presses any key on the keyboard.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8be9fd">char</span> <span style="color:#50fa7b">my_function</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// even Alan Turing cannot tell when this will return
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">return</span> <span style="color:#50fa7b">getchar</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>To make fair and efficient use of the CPU, <code>read()</code> and similar syscalls are
not implemented as a busy waiting loop, which just wastes CPU cycles.
Instead, it lets other threads run and comes back only when required resources
become available.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8be9fd">ssize_t</span> <span style="color:#50fa7b">read</span>(<span style="color:#8be9fd">int</span> fd, <span style="color:#8be9fd">void</span> <span style="color:#ff79c6">*</span>buf, <span style="color:#8be9fd">size_t</span> count) {
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">check_resource</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">!</span>available) {
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// yields the CPU to other threads
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#50fa7b">sleep_until_resource_available</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// woken up by someone, go back and check again
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">goto</span> check_resource;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">memcpy</span>(...); <span style="color:#6272a4">// or whatever code to read the resource
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>In MOS, a <code>waitlist</code> is used to keep track of threads that are waiting for resources:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">check_server</span>:
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">!</span>server_found)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">pr_info</span>(<span style="color:#f1fa8c">&#34;no server &#39;%s&#39; found, waiting for it to be created...&#34;</span>, name);
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">waitlist_append</span>(server_waitlist);
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">blocked_reschedule</span>(); <span style="color:#6272a4">// marks the thread as blocked and reschedules
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">pr_info</span>(<span style="color:#f1fa8c">&#34;woken up, check again...&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// woken up by someone, go back and check again
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">goto</span> check_server;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">pr_info</span>(<span style="color:#f1fa8c">&#34;server &#39;%s&#39; found&#34;</span>, name);
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="what-wakes-you-up">
  What Wakes You Up?
  <a class="heading-link" href="#what-wakes-you-up">
    <i class="fa-solid fa-link" aria-hidden="true" title="链接到标题"></i>
    <span class="sr-only">链接到标题</span>
  </a>
</h4>
<p>When the resource becomes available, the resource owner will iterate through its
<code>waitlist</code> and set the thread&rsquo;s state to <code>READY</code>. The thread will then enter the
scheduling candidate queue and is ready to run again in the next scheduling round.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#6272a4">// something like this
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#8be9fd">void</span> <span style="color:#50fa7b">waitlist_wakeup</span>(<span style="color:#8be9fd">waitlist_t</span> <span style="color:#ff79c6">*</span>waitlist)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">list_foreach</span>(<span style="color:#8be9fd">thread_t</span>, <span style="color:#ff79c6">thread</span>, waitlist<span style="color:#ff79c6">-&gt;</span>threads) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">thread</span><span style="color:#ff79c6">-&gt;</span>state <span style="color:#ff79c6">=</span> READY;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>There seems to be nothing notable. When the thread wakes up, it simply
continues to execute the syscall with its desired resource available.</p>
<hr>
<h2 id="signals-ruin-everything">
  Signals Ruin Everything
  <a class="heading-link" href="#signals-ruin-everything">
    <i class="fa-solid fa-link" aria-hidden="true" title="链接到标题"></i>
    <span class="sr-only">链接到标题</span>
  </a>
</h2>
<p><strong>What Happens When a Signal is Delivered?</strong></p>
<blockquote>
<p>&lsquo;signal handler is invoked&hellip;&rsquo; &mdash; POSIX</p>
</blockquote>
<p>In MOS, whenever a signal is delivered to a thread, it is stored in a per-thread
linked list called <code>sigpending</code>, and the thread&rsquo;s state is set to <code>READY</code>.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#6272a4">// something like this
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#8be9fd">void</span> <span style="color:#50fa7b">signal_deliver</span>(<span style="color:#8be9fd">thread_t</span> <span style="color:#ff79c6">*</span><span style="color:#ff79c6">thread</span>, <span style="color:#8be9fd">int</span> signo)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#50fa7b">list_append</span>(<span style="color:#ff79c6">thread</span><span style="color:#ff79c6">-&gt;</span>sigpending_list, signo);
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">thread</span><span style="color:#ff79c6">-&gt;</span>state <span style="color:#ff79c6">=</span> READY;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>To get signals handled as soon as possible, the thread should leave the
syscall and handle the signal first.</p>
<p><strong>So&hellip;</strong></p>
<p>A check-and-return is added in the syscall to handle wakeups like this. If the
thread is interrupted by a signal, it should return immediately, without executing
further code in the syscall.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-diff" data-lang="diff"><span style="display:flex;"><span>void my_syscall() {
</span></span><span style="display:flex;"><span>  check_resource:
</span></span><span style="display:flex;"><span>    bool available = check_resource();
</span></span><span style="display:flex;"><span>    if (!available) {
</span></span><span style="display:flex;"><span>        waitlist_append(resource_waitlist);
</span></span><span style="display:flex;"><span>        blocked_reschedule(); // marks the thread as blocked and reschedules
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b;font-weight:bold">+         if (signal_has_pending()) {
</span></span></span><span style="display:flex;"><span><span style="color:#50fa7b;font-weight:bold">+             // cleanup and return immediately
</span></span></span><span style="display:flex;"><span><span style="color:#50fa7b;font-weight:bold">+             return -EINTR; // we are interrupted by a signal
</span></span></span><span style="display:flex;"><span><span style="color:#50fa7b;font-weight:bold">+         }
</span></span></span><span style="display:flex;"><span><span style="color:#50fa7b;font-weight:bold"></span>
</span></span><span style="display:flex;"><span>        // woken up by someone, go back and check again
</span></span><span style="display:flex;"><span>        goto check_resource;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    use_resource();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>The signal handler is then invoked as normal, followed by a <code>sigreturn</code> trampoline
to return to a <em><strong>&lsquo;pre-signal context&rsquo;</strong></em>.</p>
<h3 id="where-are-we-returning-to">
  Where are we returning to?
  <a class="heading-link" href="#where-are-we-returning-to">
    <i class="fa-solid fa-link" aria-hidden="true" title="链接到标题"></i>
    <span class="sr-only">链接到标题</span>
  </a>
</h3>
<p>Tl;dr: The instruction after the syscall instruction, with <code>-EINTR</code> as the return
value.</p>
<p>The entire flow is like this:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-txt" data-lang="txt"><span style="display:flex;"><span>userspace                 kernel space
</span></span><span style="display:flex;"><span>|
</span></span><span style="display:flex;"><span>|- `syscall` instruction
</span></span><span style="display:flex;"><span>|------------------------&gt;|
</span></span><span style="display:flex;"><span>                          |- do_syscall_XXX()
</span></span><span style="display:flex;"><span>                          |- return_to_userspace()
</span></span><span style="display:flex;"><span>                               |- check_signal_pending() =&gt; true
</span></span><span style="display:flex;"><span>                                   |- save_context()
</span></span><span style="display:flex;"><span>                                   |- jump_to_signal_handler()
</span></span><span style="display:flex;"><span>    |&lt;-----------------------------|
</span></span><span style="display:flex;"><span>    |- signal handler
</span></span><span style="display:flex;"><span>    |- sigreturn()
</span></span><span style="display:flex;"><span>    |- `syscall`
</span></span><span style="display:flex;"><span>    |--------------------&gt;|
</span></span><span style="display:flex;"><span>                          |- do_syscall_sigreturn()
</span></span><span style="display:flex;"><span>                          |- return_to_userspace()
</span></span><span style="display:flex;"><span>                                |- check_signal_pending() =&gt; false
</span></span><span style="display:flex;"><span>                                |- restore_context()
</span></span><span style="display:flex;"><span>                                |- return_to_userspace()
</span></span><span style="display:flex;"><span>|&lt;------------------------------|
</span></span><span style="display:flex;"><span>|- syscall returns
</span></span><span style="display:flex;"><span>|- ... program continues
</span></span></code></pre></td></tr></table>
</div>
</div><p>The program will get the return value of the syscall, but the return value is <code>-EINTR</code>,
which means the syscall is interrupted by a signal.</p>
<p>This return value is rarely a desired one, a program in this case should check for
the return value and decide what to do next. If the program wants to retry
the syscall, it should call syscall again with the same arguments.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8be9fd">ssize_t</span> <span style="color:#50fa7b">boilerplate_read</span>(<span style="color:#8be9fd">int</span> fd, <span style="color:#8be9fd">void</span> <span style="color:#ff79c6">*</span>buf, <span style="color:#8be9fd">size_t</span> count)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">ssize_t</span> ret;
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">do</span> {
</span></span><span style="display:flex;"><span>        ret <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">syscall_read</span>(fd, buf, count);
</span></span><span style="display:flex;"><span>    } <span style="color:#ff79c6">while</span> (ret <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">-</span>EINTR);
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> ret;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>The code above looks like a boilerplate, and it is. It is also error-prone, as
the programmer may forget to check the return value and retry the syscall.</p>
<h2 id="can-we-do-better">
  Can we do better?
  <a class="heading-link" href="#can-we-do-better">
    <i class="fa-solid fa-link" aria-hidden="true" title="链接到标题"></i>
    <span class="sr-only">链接到标题</span>
  </a>
</h2>
<p>Given the fact that some signals are only &lsquo;informative&rsquo;, and has no
side-effects on neither the program nor the kernel, it is safe to restart
the interrupted syscall automatically after signal handler returns.</p>
<p>Examples of these signals are <code>SIGCHLD</code> and <code>SIGWINCH</code>.</p>
<p>Is there a way to restart such syscalls automatically, so that programmers don&rsquo;t
have to deal with <code>-EINTR</code> return values?</p>
<p>Short answer: Yes.</p>
<h3 id="sa_restart-and-siginterrupt3p">
  SA_RESTART and siginterrupt(3p)
  <a class="heading-link" href="#sa_restart-and-siginterrupt3p">
    <i class="fa-solid fa-link" aria-hidden="true" title="链接到标题"></i>
    <span class="sr-only">链接到标题</span>
  </a>
</h3>
<p>In POSIX, one can tell the kernel to restart the interrupted syscall automatically
upon receiving a signal by calling <code>siginterrupt(3p)</code>. Or by setting the <code>SA_RESTART</code>
flag in <code>sigaction(2)</code>.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8be9fd">int</span> <span style="color:#50fa7b">siginterrupt</span>(<span style="color:#8be9fd">int</span> sig, <span style="color:#8be9fd">int</span> flag);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">struct</span> sigaction {
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">int</span> sa_flags;
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">handler_t</span> <span style="color:#50fa7b">sigaction</span>(<span style="color:#8be9fd">int</span> signum, <span style="color:#ff79c6">const</span> <span style="color:#ff79c6">struct</span> sigaction <span style="color:#ff79c6">*</span>act, <span style="color:#ff79c6">struct</span> sigaction <span style="color:#ff79c6">*</span>oldact);
</span></span></code></pre></td></tr></table>
</div>
</div><p>In MOS (specifically, in <code>mlibc</code>). The first one is a compatibility wrapper of
the latter.</p>
<h3 id="what-does-the-kernel-need-to-know-to-restart-the-syscall">
  What does the kernel need to know, to restart the syscall?
  <a class="heading-link" href="#what-does-the-kernel-need-to-know-to-restart-the-syscall">
    <i class="fa-solid fa-link" aria-hidden="true" title="链接到标题"></i>
    <span class="sr-only">链接到标题</span>
  </a>
</h3>
<p>The kernel needs to know at least these things to restart the syscall:</p>
<ol>
<li>
<p>The syscall is <strong>interrupted</strong> by a signal.<br>
This one is easy, upon receiving a signal, syscall handlers can return <code>-EINTR</code>
to indicate that the syscall is interrupted by a signal.</p>
</li>
<li>
<p>The user <strong>wants to</strong> restart an interrupted syscall for <strong>this signal</strong>.<br>
This is also trivial, the kernel can simply check the <code>SA_RESTART</code> flag in
the <code>sigaction</code> struct.</p>
</li>
<li>
<p>The exact syscall number and arguments to restart.<br>
This is kinda easy, they are already in the registers when the syscall is
interrupted.</p>
</li>
<li>
<p>The syscall is <strong>&lsquo;restartable&rsquo;</strong>, i.e. the syscall makes sense to be restarted.<br>
This is the most difficult one. A special return value is needed to distinguish
whether the syscall wants itself to be restarted or not.</p>
<p><code>-EINTR</code> is not a good choice, we need a new return value.</p>
</li>
</ol>
<h3 id="-erestartsys-comes-to-the-rescue">
  -ERESTARTSYS Comes to the Rescue
  <a class="heading-link" href="#-erestartsys-comes-to-the-rescue">
    <i class="fa-solid fa-link" aria-hidden="true" title="链接到标题"></i>
    <span class="sr-only">链接到标题</span>
  </a>
</h3>
<p>In Linux, the kernel returns <code>-ERESTARTSYS</code> to indicate that the syscall is
interrupted by a signal, and the syscall is restartable. This is also the case
in MOS.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#6272a4">// in Linux
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">if</span> (<span style="color:#50fa7b">signal_pending</span>(current))
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">-</span>ERESTARTSYS;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// in MOS
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">if</span> (<span style="color:#50fa7b">signal_has_pending</span>(current))
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">-</span>ERESTARTSYS;
</span></span></code></pre></td></tr></table>
</div>
</div><p>The signal checker is also modified to check if <code>-ERESTARTSYS</code> is returned and if
<code>SA_RESTART</code> is set:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8be9fd">reg_t</span> real_ret <span style="color:#ff79c6">=</span> syscall_ret;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">if</span> (real_ret <span style="color:#ff79c6">==</span> (<span style="color:#8be9fd">reg_t</span>) <span style="color:#ff79c6">-</span>ERESTARTSYS) {
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// interrupted by a signal
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    real_ret <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">-</span>EINTR; <span style="color:#6272a4">// we don&#39;t leak -ERESTARTSYS to userspace
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">if</span> (action.sa_flags <span style="color:#ff79c6">&amp;</span> SA_RESTART)
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// restart the syscall
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#50fa7b">set_syscall_restart</span>(regs, syscall_nr);
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">else</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// return -EINTR
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#50fa7b">set_syscall_result</span>(regs, real_ret);
</span></span><span style="display:flex;"><span>} <span style="color:#ff79c6">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// normal return value
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#50fa7b">set_syscall_result</span>(regs, real_ret);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">handle_signal</span>();
</span></span></code></pre></td></tr></table>
</div>
</div><p>Note that <code>-ERESTARTSYS</code> is not leaked to userspace, it is solely used by the
kernel to indicate that the syscall is interrupted by a signal and is restartable.</p>
<p>What happens here is:</p>
<ol>
<li>after a syscall function detects that the syscall is interrupted by a signal
<ul>
<li>it returns <code>-ERESTARTSYS</code> or <code>-EINTR</code></li>
<li>based on whether it is restartable or not</li>
</ul>
</li>
<li>before returning to userspace, signal handling code checks:
<ul>
<li>if a signal is pending, yes in this case</li>
<li>if <code>SA_RESTART</code> for this signal is set
<ul>
<li>if yes, modify the context so that the syscall can be restarted
<ul>
<li>automatically (see below)</li>
</ul>
</li>
<li>if no, return <code>-EINTR</code> to the userspace program (instead of <code>-ERESTARTSYS</code>)
<ul>
<li>because the user does not want to restart the syscall</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>invoke the signal handler</li>
<li>if the signal handler returns by <code>sigreturn()</code>
<ul>
<li>restore pre-signal context</li>
<li>return to userspace</li>
</ul>
</li>
<li>the syscall is restarted (automatically) if <code>SA_RESTART</code> is set</li>
</ol>
<h3 id="how-this-works">
  How This Works?
  <a class="heading-link" href="#how-this-works">
    <i class="fa-solid fa-link" aria-hidden="true" title="链接到标题"></i>
    <span class="sr-only">链接到标题</span>
  </a>
</h3>
<p>The <code>set_syscall_restart()</code> function is modifies the context of the thread
(i.e. registers) so that the syscall can be restarted automatically.</p>
<p>It achieves this by playing with the instruction pointer:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8be9fd">void</span> <span style="color:#50fa7b">set_syscall_restart</span>(<span style="color:#8be9fd">regs_t</span> <span style="color:#ff79c6">*</span>regs, <span style="color:#8be9fd">int</span> syscall_nr)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// in MOS, syscall_nr is in rax
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    regs<span style="color:#ff79c6">-&gt;</span>rax <span style="color:#ff79c6">=</span> syscall_nr;
</span></span><span style="display:flex;"><span>    regs<span style="color:#ff79c6">-&gt;</span>rip <span style="color:#ff79c6">-=</span> <span style="color:#bd93f9">2</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>It places the syscall number in <code>rax</code>, the register that stores the syscall number
in MOS, and decrements the instruction pointer by 2.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#50fa7b">int</span> <span style="color:#bd93f9">0x88</span>    <span style="color:#6272a4">; 2 bytes (0xcd 0x88)
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#50fa7b">syscall</span>     <span style="color:#6272a4">; 2 bytes (0x0f 0x05)
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>2 in this case is the length of the <code>syscall</code> instruction (or <code>int 0x88</code>) when encoded
in x86-64. Whether it is a coincidence or not, the lengths of these two instructions
are the same.</p>
<p>After the context has been modified, when the thread returns to userspace, instead
of going to the next instruction, it will execute the <code>syscall</code> (or <code>int 0x88</code>)
instruction again. From the outside, it looks like the syscall is restarted
automatically.</p>
<p>The overall flow of automatic syscall restart is in the diagram below:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-diff" data-lang="diff"><span style="display:flex;"><span> userspace                 kernel space
</span></span><span style="display:flex;"><span> |
</span></span><span style="display:flex;"><span> |- `syscall` instruction
</span></span><span style="display:flex;"><span> |------------------------&gt;|
</span></span><span style="display:flex;"><span>                           |- do_syscall_XXX()
</span></span><span style="display:flex;"><span><span style="color:#50fa7b;font-weight:bold">+                          |  // returns -ERESTARTSYS
</span></span></span><span style="display:flex;"><span><span style="color:#50fa7b;font-weight:bold"></span>                           |- return_to_userspace()
</span></span><span style="display:flex;"><span>                                |- check_signal_pending() =&gt; true
</span></span><span style="display:flex;"><span><span style="color:#50fa7b;font-weight:bold">+                                   |- set_syscall_restart() // ip -= 2
</span></span></span><span style="display:flex;"><span><span style="color:#50fa7b;font-weight:bold"></span>                                    |- save_context()
</span></span><span style="display:flex;"><span>                                    |- jump_to_signal_handler()
</span></span><span style="display:flex;"><span>     |&lt;-----------------------------|
</span></span><span style="display:flex;"><span>     |- signal handler
</span></span><span style="display:flex;"><span>     |- sigreturn()
</span></span><span style="display:flex;"><span>     |- `syscall`
</span></span><span style="display:flex;"><span>     |--------------------&gt;|
</span></span><span style="display:flex;"><span>                           |- do_syscall_sigreturn()
</span></span><span style="display:flex;"><span>                           |- return_to_userspace()
</span></span><span style="display:flex;"><span>                                 |- check_signal_pending() =&gt; assumed false
</span></span><span style="display:flex;"><span>                                 |- restore_context()
</span></span><span style="display:flex;"><span>                                 |- return_to_userspace()
</span></span><span style="display:flex;"><span> |&lt;------------------------------|
</span></span><span style="display:flex;"><span><span style="color:#50fa7b;font-weight:bold">+|- `syscall` instruction (again)
</span></span></span><span style="display:flex;"><span><span style="color:#50fa7b;font-weight:bold">+|------------------------&gt;|
</span></span></span><span style="display:flex;"><span><span style="color:#50fa7b;font-weight:bold">+                          |- do_syscall_XXX()
</span></span></span><span style="display:flex;"><span><span style="color:#50fa7b;font-weight:bold">+                          |  // returns normally
</span></span></span><span style="display:flex;"><span><span style="color:#50fa7b;font-weight:bold">+                          |- return_to_userspace()
</span></span></span><span style="display:flex;"><span><span style="color:#50fa7b;font-weight:bold">+                                |- check_signal_pending() =&gt; assumed false
</span></span></span><span style="display:flex;"><span><span style="color:#50fa7b;font-weight:bold">+                                |- restore_context()
</span></span></span><span style="display:flex;"><span><span style="color:#50fa7b;font-weight:bold">+                                |- return_to_userspace()
</span></span></span><span style="display:flex;"><span><span style="color:#50fa7b;font-weight:bold">+|&lt;------------------------------|
</span></span></span><span style="display:flex;"><span><span style="color:#50fa7b;font-weight:bold"></span> |- syscall returns
</span></span><span style="display:flex;"><span> |- ... program continues
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="why-mangling-the-instruction-pointer">
  Why mangling the instruction pointer?
  <a class="heading-link" href="#why-mangling-the-instruction-pointer">
    <i class="fa-solid fa-link" aria-hidden="true" title="链接到标题"></i>
    <span class="sr-only">链接到标题</span>
  </a>
</h3>
<p>Several other approaches exist, for example:</p>
<ol>
<li>
<p>store the syscall number, arguments somewhere in the thread&rsquo;s context, and call
the syscall in kernel mode from <code>sigreturn()</code></p>
<ul>
<li>it requires more space to store all arguments (10+ registers * 8 bytes)</li>
<li>it is also unnecessary to store them somewhere else, given they are already
in the registers when the syscall is interrupted.</li>
<li>syscall entry point is sometimes a tracepoint, it helps the kernel to
trace syscalls&rsquo; entry and exit, and it&rsquo;s unsuitable to be invoked from
kernel mode code.</li>
</ul>
</li>
<li>
<p>place the <code>-EINTR</code> return value checker in <code>libc</code> and restart the syscall
from there</p>
<ul>
<li>it requires <code>libc</code> to be aware of the syscall restart mechanism</li>
<li>it is not a good idea to put syscall restart logic in <code>libc</code>, as it is
a userspace library, and it is not the only one. Caller libraries may
also want to handle <code>-EINTR</code> return values differently.</li>
</ul>
</li>
</ol>
<h3 id="concerns-and-limitations">
  Concerns and Limitations
  <a class="heading-link" href="#concerns-and-limitations">
    <i class="fa-solid fa-link" aria-hidden="true" title="链接到标题"></i>
    <span class="sr-only">链接到标题</span>
  </a>
</h3>
<ol>
<li>
<p>Imagine a syscall that takes a pointer to a buffer as its argument, and the
buffer is modified by the syscall. If the syscall is interrupted by a signal,
and the syscall is restarted automatically, the buffer will be modified twice.</p>
<ul>
<li>This senario just doen&rsquo;t exist. <code>-EINTR</code> and <code>-ERESTARTSYS</code> are only returned
when the syscall is interrupted and when the syscall haven&rsquo;t done anything
yet. Examples of these syscalls includes <code>read(2)</code>, if any data is read,
the syscall will return immediately, with the number of bytes read instead
of <code>-EINTR</code> or <code>-ERESTARTSYS</code>.</li>
</ul>
</li>
<li>
<p>What if the syscall is restarted automatically, and the signal interrupts it
again?</p>
<p>The syscall function doesn&rsquo;t know whether it is restarted automatically or
it&rsquo;s the first time it is called. Interrupting it again will result in
the same behaviour as interrupting it the first time.</p>
</li>
<li>
<p>Certain system calls are not restartable, for example, <code>nanosleep(2)</code>,
<code>nanosleep(2)</code> takes a <code>struct timespec</code> as its argument, and the kernel needs
to calculate the remaining time to sleep and restart the syscall with the
remaining time.</p>
</li>
</ol>
<h2 id="conclusion">
  Conclusion
  <a class="heading-link" href="#conclusion">
    <i class="fa-solid fa-link" aria-hidden="true" title="链接到标题"></i>
    <span class="sr-only">链接到标题</span>
  </a>
</h2>
<p>In this post, signals, and how they interrupt syscalls are discussed. The
automatic restart of signal-interrupted syscalls is also discussed.</p>
<p>The MOS kernel implements automatic restart of signal-interrupted syscalls
in commit <a href="https://github.com/moodyhunter/MOS/commit/5ba8cc0b5935c608cf4490cc6035ab30649b8db3"  class="external-link" target="_blank" rel="noopener">5ba8cc0b5935c608cf4490cc6035ab30649b8db3</a></p>
<hr>
<h2 id="references">
  References
  <a class="heading-link" href="#references">
    <i class="fa-solid fa-link" aria-hidden="true" title="链接到标题"></i>
    <span class="sr-only">链接到标题</span>
  </a>
</h2>
<ul>
<li>MOS Source Code</li>
<li>Linux Source Code</li>
<li><a href="https://pubs.opengroup.org/onlinepubs/9699919799/"  class="external-link" target="_blank" rel="noopener">POSIX.1-2017</a></li>
<li><code>signal(7)</code></li>
</ul>

      </div>


      <footer>
        


        
        
        <div class="comments">
  <script>

    let getTheme = window.localStorage && window.localStorage.getItem("colorscheme");
    let themeInParams = '';

    if (getTheme == null) {
      if (themeInParams !== '' && themeInParams !== 'auto') {
        getTheme = themeInParams;
      }
      else {
        getTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? "dark" : "light";
      }
    }

    let theme = getTheme === 'dark' ? 'github-dark' : 'github-light';
    let s = document.createElement('script');
    s.src = 'https://utteranc.es/client.js';
    s.setAttribute('repo', 'moodyhunter\/moodyhunter.github.io');
    s.setAttribute('issue-term', 'pathname');
    s.setAttribute('theme', theme);
    s.setAttribute('crossorigin', 'anonymous');
    s.setAttribute('async', '');
    document.querySelector('div.comments').innerHTML = '';
    document.querySelector('div.comments').appendChild(s);

  </script>
</div>
        
        

        
      </footer>
    </article>

    
  </section>

    </div>

    <footer class="footer">
  <section class="container">
    ©
    
      2021 -
    
    2024
     Moody 
    ·
    
      许可依据 <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA-4.0</a>
    ·
    
    技术支持 <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/" target="_blank" rel="noopener">Coder</a>.
    
  </section>
</footer>

  </main>

  

  
  
  <script src="/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js" integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script>
  

  

  


  

  

  

  

  

  

  

  

  

  <script type="text/javascript">
    !function(T,l,y){var S=T.location,k="script",D="connectionString",C="ingestionendpoint",I="disableExceptionTracking",E="ai.device.",b="toLowerCase",w="crossOrigin",N="POST",e="appInsightsSDK",t=y.name||"appInsights";(y.name||T[e])&&(T[e]=t);var n=T[t]||function(d){var g=!1,f=!1,m={initialize:!0,queue:[],sv:"5",version:2,config:d};function v(e,t){var n={},a="Browser";return n[E+"id"]=a[b](),n[E+"type"]=a,n["ai.operation.name"]=S&&S.pathname||"_unknown_",n["ai.internal.sdkVersion"]="javascript:snippet_"+(m.sv||m.version),{time:function(){var e=new Date;function t(e){var t=""+e;return 1===t.length&&(t="0"+t),t}return e.getUTCFullYear()+"-"+t(1+e.getUTCMonth())+"-"+t(e.getUTCDate())+"T"+t(e.getUTCHours())+":"+t(e.getUTCMinutes())+":"+t(e.getUTCSeconds())+"."+((e.getUTCMilliseconds()/1e3).toFixed(3)+"").slice(2,5)+"Z"}(),name:"Microsoft.ApplicationInsights."+e.replace(/-/g,"")+"."+t,sampleRate:100,tags:n,data:{baseData:{ver:2}}}}var h=d.url||y.src;if(h){function a(e){var t,n,a,i,r,o,s,c,u,p,l;g=!0,m.queue=[],f||(f=!0,t=h,s=function(){var e={},t=d.connectionString;if(t)for(var n=t.split(";"),a=0;a<n.length;a++){var i=n[a].split("=");2===i.length&&(e[i[0][b]()]=i[1])}if(!e[C]){var r=e.endpointsuffix,o=r?e.location:null;e[C]="https://"+(o?o+".":"")+"dc."+(r||"services.visualstudio.com")}return e}(),c=s[D]||d[D]||"",u=s[C],p=u?u+"/v2/track":d.endpointUrl,(l=[]).push((n="SDK LOAD Failure: Failed to load Application Insights SDK script (See stack for details)",a=t,i=p,(o=(r=v(c,"Exception")).data).baseType="ExceptionData",o.baseData.exceptions=[{typeName:"SDKLoadFailed",message:n.replace(/\./g,"-"),hasFullStack:!1,stack:n+"\nSnippet failed to load ["+a+"] -- Telemetry is disabled\nHelp Link: https://go.microsoft.com/fwlink/?linkid=2128109\nHost: "+(S&&S.pathname||"_unknown_")+"\nEndpoint: "+i,parsedStack:[]}],r)),l.push(function(e,t,n,a){var i=v(c,"Message"),r=i.data;r.baseType="MessageData";var o=r.baseData;return o.message='AI (Internal): 99 message:"'+("SDK LOAD Failure: Failed to load Application Insights SDK script (See stack for details) ("+n+")").replace(/\"/g,"")+'"',o.properties={endpoint:a},i}(0,0,t,p)),function(e,t){if(JSON){var n=T.fetch;if(n&&!y.useXhr)n(t,{method:N,body:JSON.stringify(e),mode:"cors"});else if(XMLHttpRequest){var a=new XMLHttpRequest;a.open(N,t),a.setRequestHeader("Content-type","application/json"),a.send(JSON.stringify(e))}}}(l,p))}function i(e,t){f||setTimeout(function(){!t&&m.core||a()},500)}var e=function(){var n=l.createElement(k);n.src=h;var e=y[w];return!e&&""!==e||"undefined"==n[w]||(n[w]=e),n.onload=i,n.onerror=a,n.onreadystatechange=function(e,t){"loaded"!==n.readyState&&"complete"!==n.readyState||i(0,t)},n}();y.ld<0?l.getElementsByTagName("head")[0].appendChild(e):setTimeout(function(){l.getElementsByTagName(k)[0].parentNode.appendChild(e)},y.ld||0)}try{m.cookie=l.cookie}catch(p){}function t(e){for(;e.length;)!function(t){m[t]=function(){var e=arguments;g||m.queue.push(function(){m[t].apply(m,e)})}}(e.pop())}var n="track",r="TrackPage",o="TrackEvent";t([n+"Event",n+"PageView",n+"Exception",n+"Trace",n+"DependencyData",n+"Metric",n+"PageViewPerformance","start"+r,"stop"+r,"start"+o,"stop"+o,"addTelemetryInitializer","setAuthenticatedUserContext","clearAuthenticatedUserContext","flush"]),m.SeverityLevel={Verbose:0,Information:1,Warning:2,Error:3,Critical:4};var s=(d.extensionConfig||{}).ApplicationInsightsAnalytics||{};if(!0!==d[I]&&!0!==s[I]){var c="onerror";t(["_"+c]);var u=T[c];T[c]=function(e,t,n,a,i){var r=u&&u(e,t,n,a,i);return!0!==r&&m["_"+c]({message:e,url:t,lineNumber:n,columnNumber:a,error:i}),r},d.autoExceptionInstrumented=!0}return m}(y.cfg);function a(){y.onInit&&y.onInit(n)}(T[t]=n).queue&&0===n.queue.length?(n.queue.push(a),n.trackPageView({})):a()}(window,document,{
    src: "https://js.monitor.azure.com/scripts/b/ai.2.min.js", 
    
    
    
    crossOrigin: "anonymous", 
    
    cfg: { 
        connectionString: "InstrumentationKey=5a5bbde5-faba-4982-8376-789e51b32d12;IngestionEndpoint=https:\/\/uksouth-1.in.applicationinsights.azure.com\/;LiveEndpoint=https:\/\/uksouth.livediagnostics.monitor.azure.com\/"
         
    }});
    </script>    


  

  

  

  

  

  
</body>

</html>
